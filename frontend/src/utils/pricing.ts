
// Fabric data from fabrics_filtered_with_groups.json (G1, G2, G3 only â€” G4/G5 not applicable)
export const FABRIC_DATA: Record<string, Record<string, { group: string; colors: string[] }>> = {
    "Alpha": {
        "Avoca Block Out": { "group": "G2", "colors": ["Alabaster", "Black", "Chocolate", "Cream", "Dark Grey", "Ebony", "Ivory", "Lace", "Lght Grey", "Linen", "Mist", "Off White", "Pebble", "Powder", "Shale", "Stone", "White"] },
        "Bondi Block Out": { "group": "G2", "colors": ["Cappuccino", "Champagne", "Dove", "Grey", "Leather", "Midnight", "White"] },
        "Bondi Light Filtering": { "group": "G2", "colors": ["Cappuccino", "Champagne", "Dove", "Grey", "Leather", "Midnight", "White"] },
        "Cottesloe Block Out": { "group": "G2", "colors": ["Biscuit Pearl", "Black Pearl", "Cream Pearl", "Metallic", "Silver Cloud", "Silver Pearl", "White Pearl"] },
        "Cottesloe Light Filtering": { "group": "G2", "colors": ["Biscuit Pearl", "Black Pearl", "Cream Pearl", "Metallic", "Silver Cloud", "Silver Pearl", "White Pearl"] },
        "Dalkeith Block Out": { "group": "G2", "colors": ["Beach Pearl", "Cream Pearl", "Dark Pearl", "Misty Pearl", "Silver Pearl", "White"] },
        "Dalkeith Light Filtering": { "group": "G2", "colors": ["Beach Pearl", "Cream Pearl", "Dark Pearl", "Misty Pearl", "Silver Pearl", "White"] },
        "Glenelg Block Out": { "group": "G2", "colors": ["Biscuit", "Cappuccino", "Cream", "Fog", "Seed Pearl", "White"] },
        "Glenelg Light Filtering": { "group": "G2", "colors": ["Biscuit", "Cappuccino", "Cream", "Fog", "Seed Pearl", "White"] },
        "Toorak Block Out": { "group": "G2", "colors": ["Blaze", "Grey Stone", "Nougat", "Off White", "Seed Pearl", "Silver", "Storm", "White"] },
        "Toorak Light Filtering": { "group": "G2", "colors": ["Blaze", "Grey Stone", "Nougat", "Off White", "Seed Pearl", "Silver", "Storm", "White"] },
        "Vaucluse Block Out": { "group": "G2", "colors": ["Biscuit", "Off White", "Pewter", "Shale", "Silver Grey", "White"] },
        "Vaucluse Light Filtering": { "group": "G2", "colors": ["Biscuit", "Off White", "Pewter", "Shale", "Silver Grey", "White"] }
    },
    "Gracetech": {
        "Platinum P05": { "group": "G1", "colors": ["2001 White", "2002 White Beige", "2003 White Grey", "2004 Beige", "2005 Beige Grey", "2006 Grey", "2007 Black Grey", "2009 Black", "2050 White Pearl", "2066 Super White", "2067 Charcoal Grey", "2079 Charcoal", "2080 caramel", "2081 Casper", "2082 Fudge", "2083 Hammer", "2084 Cloud Grey", "2098A Black Copper"] },
        "Platinum P10": { "group": "G1", "colors": ["2001 White", "2002 White Beige", "2003 White Grey", "2004 Beige", "2005 Beige Grey", "2006 Grey", "2007 Black Grey", "2009 Black", "2050 White Pearl", "2066 Super White", "2067 Charcoal Grey", "2079 Charcoal", "2080 caramel", "2081 Casper", "2082 Fudge", "2083 Hammer", "2084 Cloud Grey", "2098A Black Copper"] }
    },
    "Textstyle": {
        "Balmoral Blockout": { "group": "G3", "colors": ["Armour", "Birch", "Bourneville", "Chrome", "Concrete", "Dove", "Jet", "Pearl", "Platinum", "Putty", "Pyrite", "Steel", "White"] },
        "Balmoral Light Filtering": { "group": "G3", "colors": ["Armour", "Birch", "Bourneville", "Chrome", "Concrete", "Dove", "Jet", "Pearl", "Platinum", "Putty", "Pyrite", "Steel", "White"] },
        "Cascata": { "group": "G2", "colors": ["Ardesia", "Avorio", "Baltico", "Corvo", "Grigio", "Mercurio", "Neve", "Nuvola", "Pepe"] },
        "Focus": { "group": "G1", "colors": ["Alabaster", "Almond", "Ash", "Bay", "Beechwood", "Carbon", "Chalk", "Cloud", "Coal", "Cotton", "Dove", "Drift", "Duck Egg", "Ebony", "Espresso", "Eucalypt", "Feather", "Fig", "Jarrah", "Latte", "Linen", "Magnetic", "Mist", "Oyster", "Polar", "Powder", "Putty", "Sandstone", "Shell", "Smoke", "Stone", "Tempest", "White"] },
        "Jersey Blockout": { "group": "G3", "colors": ["Ashen", "Basalt", "Cinder", "Ember", "Lace", "Mink", "Opal", "Render", "Sable", "Willow"] },
        "Jersey Light Filtering": { "group": "G3", "colors": ["Ashen", "Basalt", "Cinder", "Ember", "Lace", "Mink", "Opal", "Render", "Sable", "Willow"] },
        "Kleenscreen": { "group": "G2", "colors": ["Alloy", "Barley", "Black", "Black Pearl", "Charcoal", "Graphite", "Ivory", "Pewter", "Pumice", "Pure White", "Shale"] },
        "Kleenscreen Blockout": { "group": "G2", "colors": ["Alloy", "Barley", "Black", "Black Pearl", "Charcoal", "Ice", "Pewter", "Pumice"] },
        "Metroshade Blockout": { "group": "G3", "colors": ["Black", "Dove/White", "Ecru", "Ice Grey", "Moonstone", "Nougat", "Pebble", "Quill", "Seal", "Slate", "Storm", "Whitewash"] },
        "Metroshade Light Filtering": { "group": "G3", "colors": ["Dove/White", "Ecru", "Ice Grey", "Moonstone", "Nougat", "Quill"] },
        "One Screen": { "group": "G2", "colors": ["Black", "Charcoal", "Dune", "Grey", "Gunmetal", "Ice", "Linen/Bronze", "Mercury", "Sand", "Silver/Black", "Wallaby", "White"] },
        "Sanctuary Blockout": { "group": "G2", "colors": ["Baltic", "Ceramic", "Fossil", "Lava", "Limestone", "Marble", "Mineral", "Plaster", "Slate", "Suede", "Truffle"] },
        "Sanctuary Light Filtering": { "group": "G2", "colors": ["Baltic", "Ceramic", "Fossil", "Lava", "Limestone", "Marble", "Mineral", "Plaster", "Slate", "Suede", "Truffle"] }
    },
    "Uniline": {
        "Dawn": { "group": "G1", "colors": ["Alabaster", "Arum", "Ash Blue", "Beige", "Bison", "BK RB08", "Black", "Caviar", "Cotton", "Crane", "Custom Cream", "Dark Grey", "Daybreak", "Dune", "Earthen", "Ecru", "GR RB08", "Grey", "Ivory", "Light Bison", "Limestone RB08", "Linen", "Macchiato", "Mariah", "Mid Grey", "Misty", "Natural", "New Slate", "Nutmeg", "Oyster", "Pebble", "Pewter", "Putty", "Royal Blue", "Sesame", "Shale", "Slate", "Soft Grey", "Taupe", "Warm White", "WH RB08", "White"] },
        "Evolution": { "group": "G3", "colors": ["Amber", "Bisque", "Blanched", "Canvas", "Cocoa", "Dark Grey", "Egg Shell", "Fallow", "Hessian", "Light Grey", "Pepper", "RawHide", "Sepia", "Shale", "Tan", "Thunder Cloud", "White"] },
        "Sunset": { "group": "G1", "colors": ["Antique", "Ash Grey", "Bark", "Beaver", "Bone", "Cashew", "Ecru", "Flax", "Lace", "Lava", "Mushroom", "Natural", "Onyx", "parchment", "Pepper", "Sahara", "Seal", "Silver", "Snow", "Stone", "Taupe", "Vanila", "Warm Grey"] },
        "Tapestry Blockout": { "group": "G2", "colors": ["Buff", "Cloud", "Concrete", "Dove", "Gunmetal", "Portland", "Seagull", "Tuxedo", "White Wash"] },
        "Tapestry Light Filtering": { "group": "G2", "colors": ["Buff", "Cloud", "Concrete", "Dove", "Gunmetal", "Portland", "Seagull", "Tuxedo", "White Wash"] }
    },
    "Vertex": {
        "Iguzu": { "group": "G2", "colors": ["1901", "1902", "1903", "1904", "1905", "1906"] },
        "Vale Blockout": { "group": "G2", "colors": ["Apricote", "Arctic", "Cobalt", "Dove", "Graphite", "Greige", "Hazel", "Misty", "Pale Gray", "Vanilla", "White"] },
        "Vale Light Filtering": { "group": "G2", "colors": ["Apricote", "Arctic", "Cobalt", "Dove", "Graphite", "Greige", "Hazel", "Misty", "Pale Gray", "Vanilla", "White"] },
        "Vegan Block Out": { "group": "G2", "colors": ["Clover", "Jasmine", "Tansy", "Tulip", "Willow"] },
        "Vegas Blockout": { "group": "G2", "colors": ["Boulder", "Bunflow", "Caring Tan", "Cotton", "Darkwood", "Sand Dan"] },
        "Vegas Light Filtering": { "group": "G2", "colors": ["Boulder", "Bunflow", "Caring Tan", "Cotton", "Darkwood", "Sand Dan"] },
        "Velvet Block Out": { "group": "G2", "colors": ["Blush", "Chalk", "Mist", "Shell", "Whisper"] },
        "Venus Block Out": { "group": "G2", "colors": ["Dove", "Ebony", "Granite", "Linen", "Pearl", "Snow", "Stone"] },
        "Venus Light Filtering": { "group": "G2", "colors": ["Linen", "Pearl", "Snow"] },
        "Verdure Block Out": { "group": "G2", "colors": ["Charcoal", "Cystal", "Ecru", "Flint", "Fog", "Midnight", "Mist", "Onyx", "Pebble", "Rainforest", "Silver", "Tan"] },
        "Verdure Light Filter": { "group": "G2", "colors": ["Charcoal", "Crystal", "Ecru", "Flint", "Fog", "Mist", "Onyx", "Pebble", "Rainforest", "Silver", "Tan"] },
        "Vermont Block Out": { "group": "G2", "colors": ["Alabaster", "Anchor", "Denim", "Fog", "Fossil", "Onyx", "Pewter", "White"] },
        "Verne Blockout": { "group": "G2", "colors": ["Abalone", "Achor", "River", "Smoke", "Steel", "White"] },
        "Verne Light Filtering": { "group": "G2", "colors": ["Abalone", "Achor", "River", "Smoke", "Steel", "White"] },
        "Verona Block Out": { "group": "G2", "colors": ["Beige", "Black", "Gold", "Grey", "Off White", "White"] },
        "Verona Plus Block Out": { "group": "G2", "colors": ["Beige", "Black", "Gold", "Grey", "Off White", "White"] },
        "Versatile Block Out": { "group": "G1", "colors": ["Alloy", "Alloy RB08", "Bark", "Bark RB08", "Chrome", "Chrome RB08", "Cloud", "Cloud RB08", "Coal", "Coal RB08", "Coffon", "Coffon RB08", "Dusk", "Dusk RB08", "Ebony", "Ebony RB08", "Gardenia", "Gardenia RB08", "Gravel", "Gravel RB08", "Ice", "Ice RB08", "Lava", "Lava RB08", "Leather", "Leather RB08", "Luna", "Luna RB08", "Mocha", "Mocha RB08", "Natural", "Natural RB08", "Oyster", "Oyster RB08", "Peach", "Peach RB08", "Pine", "Pine RB08", "Seal", "Seal RB08", "Stone", "Stone RB08", "Taupe", "Taupe RB08", "Thunder", "Thunder RB08", "Wheat", "Wheat RB08"] },
        "Victoria Block Out": { "group": "G2", "colors": ["Chrome", "Crema", "Eucalyptus", "Grey", "Leather", "Mont Blanc", "Natural", "Pure Black", "Putty", "Snow White", "Steel"] },
        "Vintage Block Out": { "group": "G2", "colors": ["Almond", "Blush", "Chalk", "Cloud", "Espresso", "Jarrah", "Oyster"] },
        "Vintage Light Filtering": { "group": "G2", "colors": ["Almond", "Blush", "Chalk", "Cloud", "Espresso", "Jarrah", "Oyster"] },
        "Vision": { "group": "G2", "colors": ["Beige", "Beige RB08", "Black", "Black RB08", "Charcoal", "Copper", "Dark Pearl", "Grey", "Grey RB08", "Ice", "Ice RB08", "Light Grey", "Sand", "White", "White RB08"] },
        "Vista Block Out": { "group": "G2", "colors": ["Ash", "Bone", "Daisy", "Ivory", "Lace", "Silver", "Slate", "Smoke", "Storm"] },
        "Vista Light Filter": { "group": "G2", "colors": ["Ash", "Bone", "Daisy", "Ivory", "Lace", "Silver", "Slate", "Smoke", "Storm"] },
        "Vital Block Out": { "group": "G2", "colors": ["Atlantic Salt", "Fog White", "Jet Black", "Ocean Foam", "Sandstone", "Slate Grey"] },
        "Vital Light Filter": { "group": "G2", "colors": ["Atlantic Salt", "Fog White", "Jet Black", "Ocean Foam", "Sandstone", "Slate Grey"] },
        "Voltas Blockout": { "group": "G2", "colors": ["Beige", "Cream", "Mink", "Silver Grey", "Stone", "White"] },
        "Voltas Light Filtering": { "group": "G2", "colors": ["Beige", "Cream", "Mink", "Silver Grey", "Stone", "White"] }
    }
};

// Pricing matrix - BASE prices before fabric group discount
// Group discounts: G1=20%, G2=25%, G3=30%
// Only groups 1-3 are applicable
export const FABRIC_GROUP_DISCOUNTS: Record<number, number> = {
    1: 20,
    2: 25,
    3: 30,
};

export const PRICING_DATA: Record<number, Record<number, Record<number, number>>> = {
    1: {
        600: { 1200: 56.16, 1400: 58.24, 1600: 60.32, 1800: 62.4, 2000: 65.52, 2200: 68.64, 2400: 70.72, 2600: 72.8, 2800: 74.88, 3000: 78 },
        800: { 1200: 60.32, 1400: 62.4, 1600: 65.52, 1800: 68.64, 2000: 70.72, 2200: 72.8, 2400: 75.92, 2600: 79.04, 2800: 81.12, 3000: 83.2 },
        1000: { 1200: 62.4, 1400: 65.52, 1600: 68.64, 1800: 70.72, 2000: 72.8, 2200: 75.92, 2400: 79.04, 2600: 81.12, 2800: 83.2, 3000: 85.28 },
        1200: { 1200: 69.68, 1400: 71.76, 1600: 74.88, 1800: 78, 2000: 81.12, 2200: 83.2, 2400: 86.32, 2600: 89.44, 2800: 92.56, 3000: 95.68 },
        1400: { 1200: 74.88, 1400: 79.04, 1600: 82.16, 1800: 84.24, 2000: 87.36, 2200: 91.52, 2400: 95.68, 2600: 98.8, 2800: 102.96, 3000: 106.08 },
        1600: { 1200: 81.9, 1400: 85.05, 1600: 88.2, 1800: 92.4, 2000: 97.65, 2200: 100.8, 2400: 105, 2600: 108.15, 2800: 112.35, 3000: 116.55 },
        1800: { 1200: 88.2, 1400: 92.4, 1600: 97.65, 1800: 102.9, 2000: 106.05, 2200: 110.25, 2400: 115.5, 2600: 118.65, 2800: 123.9, 3000: 128.1 },
        2000: { 1200: 93.45, 1400: 98.7, 1600: 103.95, 1800: 108.15, 2000: 112.35, 2200: 117.6, 2400: 120.75, 2600: 127.05, 2800: 131.25, 3000: 135.45 },
        2200: { 1200: 116.55, 1400: 121.8, 1600: 128.1, 1800: 132.3, 2000: 138.6, 2200: 142.8, 2400: 147, 2600: 154.35, 2800: 158.55, 3000: 163.8 },
        2400: { 1200: 124.95, 1400: 131.25, 1600: 135.45, 1800: 141.75, 2000: 147, 2200: 153.3, 2400: 158.55, 2600: 164.85, 2800: 169.05, 3000: 175.35 },
        2600: { 1200: 154.76, 1400: 160.06, 1600: 166.42, 1800: 171.72, 2000: 178.08, 2200: 184.44, 2400: 190.8, 2600: 196.1, 2800: 202.46, 3000: 208.82 },
        2800: { 1200: 160.06, 1400: 167.48, 1600: 172.78, 1800: 180.2, 2000: 186.56, 2200: 192.92, 2400: 200.34, 2600: 205.64, 2800: 214.12, 3000: 219.42 },
        3000: { 1200: 163.24, 1400: 170.66, 1600: 178.08, 1800: 186.56, 2000: 193.98, 2200: 201.4, 2400: 209.88, 2600: 217.3, 2800: 224.72, 3000: 231.08 }
    },
    2: {
        600: { 1200: 62.4, 1400: 65.52, 1600: 68.64, 1800: 70.72, 2000: 72.8, 2200: 74.88, 2400: 78, 2600: 80.08, 2800: 81.12, 3000: 83.2 },
        800: { 1200: 66.56, 1400: 69.68, 1600: 72.8, 1800: 74.88, 2000: 78, 2200: 80.08, 2400: 82.16, 2600: 84.24, 2800: 89.44, 3000: 95.68 },
        1000: { 1200: 69.68, 1400: 72.8, 1600: 75.92, 1800: 79.04, 2000: 82.16, 2200: 85.28, 2400: 89.44, 2600: 91.52, 2800: 95.68, 3000: 98.8 },
        1200: { 1200: 75.92, 1400: 80.08, 1600: 83.2, 1800: 87.36, 2000: 91.52, 2200: 95.68, 2400: 99.84, 2600: 104, 2800: 107.12, 3000: 111.28 },
        1400: { 1200: 83.2, 1400: 87.36, 1600: 91.52, 1800: 96.72, 2000: 101.92, 2200: 106.08, 2400: 110.24, 2600: 114.4, 2800: 118.56, 3000: 123.76 },
        1600: { 1200: 91.35, 1400: 96.6, 1600: 100.8, 1800: 107.1, 2000: 111.3, 2200: 116.55, 2400: 121.8, 2600: 128.1, 2800: 132.3, 3000: 136.5 },
        1800: { 1200: 99.75, 1400: 106.05, 1600: 110.25, 1800: 117.6, 2000: 121.8, 2200: 129.15, 2400: 134.4, 2600: 139.65, 2800: 144.9, 3000: 152.25 },
        2000: { 1200: 106.05, 1400: 111.3, 1600: 117.6, 1800: 124.95, 2000: 131.25, 2200: 136.5, 2400: 142.8, 2600: 151.2, 2800: 156.45, 3000: 162.75 },
        2200: { 1200: 136.5, 1400: 143.85, 1600: 152.25, 1800: 157.5, 2000: 164.85, 2200: 171.15, 2400: 179.55, 2600: 186.9, 2800: 192.15, 3000: 198.45 },
        2400: { 1200: 145.95, 1400: 154.35, 1600: 162.75, 1800: 169.05, 2000: 176.4, 2200: 184.8, 2400: 192.15, 2600: 199.5, 2800: 206.85, 3000: 213.15 },
        2600: { 1200: 169.6, 1400: 177.02, 1600: 185.5, 1800: 193.98, 2000: 202.46, 2200: 210.94, 2400: 218.36, 2600: 226.84, 2800: 235.32, 3000: 243.8 },
        2800: { 1200: 177.02, 1400: 185.5, 1600: 195.04, 1800: 203.52, 2000: 213.06, 2200: 221.54, 2400: 230.02, 2600: 240.62, 2800: 246.98, 3000: 256.52 },
        3000: { 1200: 186.56, 1400: 195.04, 1600: 204.58, 1800: 215.18, 2000: 224.72, 2200: 233.2, 2400: 242.74, 2600: 252.28, 2800: 262.88, 3000: 271.36 }
    },
    3: {
        600: { 1200: 65.52, 1400: 68.64, 1600: 70.72, 1800: 73.84, 2000: 75.92, 2200: 81.12, 2400: 84.24, 2600: 87.36, 2800: 91.52, 3000: 95.68 },
        800: { 1200: 72.8, 1400: 75.92, 1600: 79.04, 1800: 82.16, 2000: 85.28, 2200: 89.44, 2400: 93.6, 2600: 97.76, 2800: 102.96, 3000: 107.12 },
        1000: { 1200: 74.88, 1400: 79.04, 1600: 83.2, 1800: 86.32, 2000: 91.52, 2200: 95.68, 2400: 99.84, 2600: 104, 2800: 108.16, 3000: 111.28 },
        1200: { 1200: 83.2, 1400: 87.36, 1600: 92.56, 1800: 97.76, 2000: 102.96, 2200: 107.12, 2400: 111.28, 2600: 117.52, 2800: 122.72, 3000: 127.92 },
        1400: { 1200: 91.52, 1400: 97.76, 1600: 102.96, 1800: 108.16, 2000: 114.4, 2200: 118.56, 2400: 125.84, 2600: 131.04, 2800: 137.28, 3000: 141.44 },
        1600: { 1200: 100.8, 1400: 107.1, 1600: 114.45, 1800: 119.7, 2000: 127.05, 2200: 133.35, 2400: 139.65, 2600: 144.9, 2800: 153.3, 3000: 158.55 },
        1800: { 1200: 110.25, 1400: 117.6, 1600: 124.95, 1800: 131.25, 2000: 139.65, 2200: 145.95, 2400: 154.35, 2600: 160.65, 2800: 168, 3000: 175.35 },
        2000: { 1200: 117.6, 1400: 124.95, 1600: 133.35, 1800: 141.75, 2000: 148.05, 2200: 157.5, 2400: 164.85, 2600: 172.2, 2800: 181.65, 3000: 113.4 },
        2200: { 1200: 142.8, 1400: 153.3, 1600: 160.65, 1800: 169.05, 2000: 178.5, 2200: 187.95, 2400: 195.3, 2600: 203.7, 2800: 213.15, 3000: 222.6 },
        2400: { 1200: 154.35, 1400: 163.8, 1600: 172.2, 1800: 182.7, 2000: 191.1, 2200: 200.55, 2400: 211.05, 2600: 219.45, 2800: 228.9, 3000: 239.4 },
        2600: { 1200: 185.5, 1400: 195.04, 1600: 205.64, 1800: 216.24, 2000: 226.84, 2200: 237.44, 2400: 246.98, 2600: 256.52, 2800: 268.18, 3000: 277.72 },
        2800: { 1200: 193.98, 1400: 204.58, 1600: 216.24, 1800: 227.9, 2000: 239.56, 2200: 250.16, 2400: 260.76, 2600: 271.36, 2800: 281.96, 3000: 294.68 },
        3000: { 1200: 204.58, 1400: 216.24, 1600: 227.9, 1800: 240.62, 2000: 252.28, 2200: 265, 2400: 275.6, 2600: 287.26, 2800: 299.98, 3000: 311.64 }
    }
};

// Helper functions for fabric data access
export function getMaterials(): string[] {
    return Object.keys(FABRIC_DATA);
}

export function getFabricTypes(material: string): string[] {
    if (!FABRIC_DATA[material]) return [];
    return Object.keys(FABRIC_DATA[material]);
}

export function getFabricColors(material: string, fabricType: string): string[] {
    if (!FABRIC_DATA[material] || !FABRIC_DATA[material][fabricType]) return [];
    return FABRIC_DATA[material][fabricType].colors;
}

export function getFabricGroup(material: string, fabricType: string): number | null {
    if (!FABRIC_DATA[material] || !FABRIC_DATA[material][fabricType]) return null;
    const groupStr = FABRIC_DATA[material][fabricType].group;
    const groupNum = parseInt(groupStr.substring(1));
    return groupNum >= 1 && groupNum <= 3 ? groupNum : null;
}

export function getPrice(width: number, drop: number, group: number): number | null {
    if (!PRICING_DATA[group]) return null;

    // Get available widths and drops
    const widths = Object.keys(PRICING_DATA[group]).map(Number).sort((a, b) => a - b);
    const drops = Object.keys(PRICING_DATA[group][widths[0]]).map(Number).sort((a, b) => a - b);

    // Find closest width by rounding to nearest (round up if exactly in middle)
    let closestWidth = widths[0];
    let minWidthDiff = Math.abs(width - widths[0]);

    for (let w of widths) {
        const diff = Math.abs(width - w);
        if (diff < minWidthDiff || (diff === minWidthDiff && w > closestWidth)) {
            minWidthDiff = diff;
            closestWidth = w;
        }
    }

    // Find closest drop by rounding to nearest (round up if exactly in middle)
    let closestDrop = drops[0];
    let minDropDiff = Math.abs(drop - drops[0]);

    for (let d of drops) {
        const diff = Math.abs(drop - d);
        if (diff < minDropDiff || (diff === minDropDiff && d > closestDrop)) {
            minDropDiff = diff;
            closestDrop = d;
        }
    }

    return PRICING_DATA[group][closestWidth][closestDrop];
}

/**
 * Calculate blind price from the pricing matrix.
 * Applies fabric group discount automatically, then any additional user discount.
 */
export function calculateBlindPrice(
    width: number,
    drop: number,
    discountPercent: number = 0,
    fabricGroup: number
): { price: number; originalPrice: number; groupDiscount: number } | null {
    if (!width || !drop || !fabricGroup) return null;

    const basePrice = getPrice(width, drop, fabricGroup);

    if (basePrice === null) return null;

    // Apply fabric group discount first
    const groupDiscountPercent = FABRIC_GROUP_DISCOUNTS[fabricGroup] || 0;
    let finalPrice = basePrice * (1 - groupDiscountPercent / 100);

    // Then apply any additional user-entered discount
    if (discountPercent > 0) {
        finalPrice = finalPrice * (1 - discountPercent / 100);
    }

    return {
        price: Number(finalPrice.toFixed(2)),
        originalPrice: basePrice,
        groupDiscount: groupDiscountPercent,
    };
}

/**
 * Determine chain length based on drop height
 * Matches backend logic in comprehensivePricing.service.ts
 */
export function getChainLength(drop: number): number {
    if (drop <= 850) return 500;
    if (drop <= 1100) return 750;
    if (drop <= 1600) return 1000;
    if (drop <= 2200) return 1200;
    return 1500; // drop > 2200mm (up to 4000mm)
}

/**
 * Check if motor is a winder (requires chain)
 */
export function isWinder(chainOrMotor: string): boolean {
    return chainOrMotor.includes('winder');
}

/**
 * Get bracket name based on motor type and selections
 * Matches backend logic
 */
export function getBracketName(chainOrMotor: string, bracketType: string, bracketColour: string): string {
    // Determine brand based on motor type
    let brand = 'Acmeda'; // Default for motors

    if (chainOrMotor === 'TBS winder-32mm') {
        brand = 'TBS';
    }

    // Build bracket name
    let bracketName = `${brand} `;

    if (bracketType === 'Single') {
        bracketName += `Single Bracket set - ${bracketColour}`;
    } else if (bracketType === 'Single Extension') {
        bracketName += `Extended Bracket set - ${bracketColour}`;
    } else if (bracketType === 'Dual Left') {
        bracketName += `Duel Bracket set Left - ${bracketColour}`;
    } else if (bracketType === 'Dual Right') {
        bracketName += `Duel Bracket set Right - ${bracketColour}`;
    }

    return bracketName;
}

/**
 * Validate TBS + Extended bracket combination
 * Returns error message if invalid, null if valid
 */
export function validateBracketSelection(chainOrMotor: string, bracketType: string): string | null {
    if (chainOrMotor === 'TBS winder-32mm' && bracketType === 'Single Extension') {
        return 'Extended bracket set is not available with TBS winder-32mm. Please select a different bracket type.';
    }
    return null;
}
