<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Shades - Order System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info span {
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .login-form, .register-form {
            max-width: 450px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }

        .tab.active {
            color: #667eea;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .order-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .order-item h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .item-detail {
            display: flex;
            flex-direction: column;
        }

        .item-detail strong {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .item-detail span {
            color: #333;
            font-size: 1.1em;
        }

        .blind-row {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .blind-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .blind-row-header h4 {
            color: #667eea;
        }

        .blind-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .blind-fields .form-group {
            margin-bottom: 0;
        }

        .price-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .price-summary h3 {
            margin-bottom: 15px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .price-row.total {
            font-size: 1.5em;
            font-weight: bold;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        .link-btn {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1em;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .orders-list {
            margin-top: 20px;
        }

        .order-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .customer-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .customer-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .customer-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .customer-stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .user-row {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: grid;
            grid-template-columns: 2fr 2fr 1.5fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .user-row:hover {
            background: #e9ecef;
        }

        .user-info-block {
            display: flex;
            flex-direction: column;
        }

        .user-info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 3px;
        }

        .user-info-value {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }

        .quote-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .quote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .quote-badge {
            background: #ffc107;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .order-filter-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .order-filter-tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .order-filter-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f0f4ff;
        }

        .status-production {
            background: #e3f2fd;
            color: #1976d2;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .order-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .blind-fields {
                grid-template-columns: 1fr;
            }

            .item-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SIGNATURE SHADES</h1>
            <p>Professional Blinds & Curtains Order System</p>
            <div id="userInfoSection" class="user-info hidden">
                <span>Welcome, <strong id="currentUserName"></strong></span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen">
                <div class="login-form">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Login</h2>
                    <div id="loginAlert"></div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="login()">Login</button>
                    <div style="text-align: center;">
                        <button class="link-btn" onclick="showRegister()">Don't have an account? Register here</button>
                    </div>
                </div>
            </div>

            <!-- Register Screen -->
            <div id="registerScreen" class="hidden">
                <div class="register-form">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Create Account</h2>
                    <div id="registerAlert"></div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label>Company Name (Optional)</label>
                        <input type="text" id="registerCompany" placeholder="Enter company name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="registerPhone" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="registerAddress" rows="3" placeholder="Enter your address"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="register()">Create Account</button>
                    <div style="text-align: center;">
                        <button class="link-btn" onclick="showLogin()">Already have an account? Login here</button>
                    </div>
                </div>
            </div>

            <!-- Main Application -->
            <div id="mainApp" class="hidden">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('newOrder')">New Order</button>
                    <button class="tab" onclick="switchTab('myOrders')">My Orders</button>
                    <button class="tab" onclick="switchTab('quickQuote')">Quick Quote</button>
                    <button class="tab hidden" id="adminTabBtn" onclick="switchTab('admin')">Admin</button>
                </div>

                <!-- New Order Tab -->
                <div id="newOrderTab" class="tab-content active">
                    <h2 style="margin-bottom: 30px; color: #333;">Create New Order</h2>
                    <div id="orderAlert"></div>
                    
                    <div class="form-group">
                        <label>Product Type</label>
                        <select id="productType" onchange="updateProductType()">
                            <option value="blinds">Blinds</option>
                            <option value="curtains">Curtains / Sheers</option>
                            <option value="shutters">Plantation Shutters</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Order Date</label>
                        <input type="date" id="orderDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Date Required By</label>
                        <input type="date" id="dateRequired">
                    </div>

                    <h3 style="margin: 30px 0 20px; color: #333;"><span id="itemTypeLabel">Blind</span> Items</h3>
                    <div id="blindItems"></div>
                    
                    <button class="btn btn-success" onclick="addItem()" style="margin-bottom: 20px;">+ Add Another <span id="addItemLabel">Blind</span></button>

                    <h3 style="margin: 30px 0 20px; color: #333;">Additional Components</h3>
                    <div class="form-group">
                        <label>Notes / Additional Components</label>
                        <textarea id="additionalNotes" rows="5" placeholder="E.g., Motors, Remotes, Special requirements, etc."></textarea>
                    </div>

                    <div class="price-summary">
                        <h3>Order Summary</h3>
                        <div class="price-row">
                            <span>Total Items:</span>
                            <span id="totalBlinds">0</span>
                        </div>
                        <div class="price-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Total:</span>
                            <span id="grandTotal">$0.00</span>
                        </div>
                    </div>

                    <button class="btn btn-primary" style="width: 100%; margin-top: 30px; padding: 15px; font-size: 1.2em;" onclick="submitOrder()">Submit Order</button>
                </div>

                <!-- My Orders Tab -->
                <div id="myOrdersTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #333;">My Orders</h2>
                    
                    <!-- Order Status Filter Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                        <button class="order-filter-tab active" data-status="all" onclick="filterMyOrders('all')">
                            All Orders (<span id="countAll">0</span>)
                        </button>
                        <button class="order-filter-tab" data-status="pending" onclick="filterMyOrders('pending')">
                            Pending (<span id="countPending">0</span>)
                        </button>
                        <button class="order-filter-tab" data-status="confirmed" onclick="filterMyOrders('confirmed')">
                            Confirmed (<span id="countConfirmed">0</span>)
                        </button>
                        <button class="order-filter-tab" data-status="production" onclick="filterMyOrders('production')">
                            Production (<span id="countProduction">0</span>)
                        </button>
                        <button class="order-filter-tab" data-status="completed" onclick="filterMyOrders('completed')">
                            Completed (<span id="countCompleted">0</span>)
                        </button>
                    </div>
                    
                    <div id="myOrdersList"></div>
                </div>

                <!-- Quick Quote Tab -->
                <div id="quickQuoteTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #333;">Quick Quote</h2>
                    <p style="margin-bottom: 20px; color: #666;">Get an instant price estimate. Save your quote or convert it to an order.</p>
                    
                    <div id="quoteAlert"></div>

                    <div class="form-group">
                        <label>Product Type</label>
                        <select id="quoteProductType" onchange="updateQuoteProductType()">
                            <option value="blinds">Blinds</option>
                            <option value="curtains">Curtains / Sheers</option>
                        </select>
                    </div>

                    <h3 style="margin: 30px 0 20px; color: #333;"><span id="quoteItemTypeLabel">Blind</span> Items</h3>
                    <div id="quoteItems"></div>
                    
                    <button class="btn btn-success" onclick="addQuoteItem()" style="margin-bottom: 20px;">+ Add Another <span id="addQuoteItemLabel">Blind</span></button>

                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="quoteNotes" rows="3" placeholder="Any special requirements or questions..."></textarea>
                    </div>

                    <div class="price-summary">
                        <h3>Quote Summary</h3>
                        <div class="price-row">
                            <span>Total Items:</span>
                            <span id="quoteTotalItems">0</span>
                        </div>
                        <div class="price-row">
                            <span>Estimated Subtotal:</span>
                            <span id="quoteSubtotal">$0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Estimated Total:</span>
                            <span id="quoteGrandTotal">$0.00</span>
                        </div>
                        <p style="font-size: 0.9em; color: rgba(255,255,255,0.8); margin-top: 10px;">*This is an estimate. Final pricing may vary.</p>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                        <button class="btn btn-primary" style="flex: 1; min-width: 200px; padding: 15px; font-size: 1.1em;" onclick="saveQuote()">ðŸ’¾ Save Quote</button>
                        <button class="btn btn-success" style="flex: 1; min-width: 200px; padding: 15px; font-size: 1.1em;" onclick="convertQuoteToOrder()">âœ“ Confirm & Place Order</button>
                    </div>

                    <!-- Saved Quotes -->
                    <div style="margin-top: 50px;">
                        <h3 style="margin-bottom: 20px; color: #333;">My Saved Quotes</h3>
                        <div id="savedQuotesList"></div>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div id="adminTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #333;">Admin Dashboard</h2>
                    
                    <!-- Admin Sub-Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                        <button class="order-filter-tab active" onclick="switchAdminSubTab('customerManagement')">
                            Customer Management
                        </button>
                        <button class="order-filter-tab" onclick="switchAdminSubTab('userManagement')">
                            User Management
                        </button>
                        <button class="order-filter-tab" onclick="switchAdminSubTab('pricing')">
                            Pricing Management
                        </button>
                        <button class="order-filter-tab" onclick="switchAdminSubTab('allOrders')">
                            All Orders
                        </button>
                    </div>
                    
                    <!-- Customer Management Sub-Tab -->
                    <div id="adminCustomerManagement" class="admin-sub-tab" style="display: block;">
                        <h3 style="margin-bottom: 20px; color: #555;">Customer Management</h3>
                        <p style="margin-bottom: 20px; color: #666;">View all customers and their order history</p>
                        
                        <div id="customerManagementList"></div>
                    </div>
                    
                    <!-- User Management Sub-Tab -->
                    <div id="adminUserManagement" class="admin-sub-tab" style="display: none;">
                        <h3 style="margin-bottom: 20px; color: #555;">User Management</h3>
                        <p style="margin-bottom: 20px; color: #666;">Create and manage customer accounts</p>
                        
                        <!-- Create User Form -->
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                            <h4 style="margin-bottom: 20px;">Create New Customer Account</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="newUserName" placeholder="Full name">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="newUserEmail" placeholder="email@example.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" id="newUserPhone" placeholder="Phone number">
                                </div>
                                <div class="form-group">
                                    <label>Company</label>
                                    <input type="text" id="newUserCompany" placeholder="Company name (optional)">
                                </div>
                                <div class="form-group">
                                    <label>Address *</label>
                                    <input type="text" id="newUserAddress" placeholder="Full address">
                                </div>
                                <div class="form-group">
                                    <label>Password *</label>
                                    <input type="password" id="newUserPassword" placeholder="Min 6 characters">
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password *</label>
                                    <input type="password" id="newUserPasswordConfirm" placeholder="Re-enter password">
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="createNewUser()" style="margin-top: 15px;">Create Account</button>
                            <div id="createUserAlert" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- User List -->
                        <h4 style="margin-bottom: 15px;">All Customer Accounts</h4>
                        <div id="userList"></div>
                    </div>
                    
                    <!-- Pricing Management Sub-Tab -->
                    <div id="adminPricing" class="admin-sub-tab" style="display: none;">
                        <h3 style="margin-bottom: 20px; color: #555;">Pricing Management</h3>
                        <p style="margin-bottom: 20px; color: #666;">Edit individual prices in the pricing tables. Changes apply immediately to new orders.</p>
                        
                        <div class="form-group">
                            <label>Select Fabric Group</label>
                            <select id="priceGroupSelect" onchange="loadPricingTable()">
                                <option value="1">Group 1</option>
                                <option value="2">Group 2</option>
                                <option value="3">Group 3</option>
                                <option value="4">Group 4</option>
                                <option value="5">Group 5</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-success" onclick="savePricing()">ðŸ’¾ Save Changes</button>
                            <button class="btn btn-secondary" onclick="resetPricing()">â†º Reset to Defaults</button>
                            <button class="btn btn-info" onclick="exportPricingToCSV()">ðŸ“¥ Export Pricing Table</button>
                        </div>

                        <div style="overflow-x: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table id="pricingTable" style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                <!-- Table will be populated by JavaScript -->
                            </table>
                        </div>

                        <div id="pricingAlert" style="margin-top: 20px;"></div>
                    </div>
                    
                    <!-- All Orders Sub-Tab -->
                    <div id="adminAllOrders" class="admin-sub-tab" style="display: none;">
                        <h3 style="margin-bottom: 20px; color: #555;">All Orders</h3>
                        
                        <!-- Product Type Filter Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                            <button class="order-filter-tab active" data-product="all" onclick="filterAllOrdersByProduct('all')">
                                All Products (<span id="productCountAll">0</span>)
                            </button>
                            <button class="order-filter-tab" data-product="blinds" onclick="filterAllOrdersByProduct('blinds')">
                                Blinds (<span id="productCountBlinds">0</span>)
                            </button>
                            <button class="order-filter-tab" data-product="curtains" onclick="filterAllOrdersByProduct('curtains')">
                                Curtains (<span id="productCountCurtains">0</span>)
                            </button>
                            <button class="order-filter-tab" data-product="shutters" onclick="filterAllOrdersByProduct('shutters')">
                                Plantation Shutters (<span id="productCountShutters">0</span>)
                            </button>
                        </div>
                        
                        <div id="allOrdersList"></div>
                    </div>
                </div>

                <!-- All Orders Tab (Admin) -->
                <div id="allOrdersTab" class="tab-content" style="display: none;">
                    <!-- OLD - Now in Admin sub-tab -->
                </div>

                <!-- Customer Management Tab (Admin) -->
                <div id="customerManagementTab" class="tab-content" style="display: none;">
                    <!-- OLD - Now in Admin sub-tab -->
                </div>

                <!-- User Management Tab (Admin) -->
                <div id="userManagementTab" class="tab-content" style="display: none;">
                    <!-- OLD - Now in Admin sub-tab -->
                </div>

                <!-- Pricing Management Tab (Admin) -->
                <div id="pricingTab" class="tab-content" style="display: none;">
                    <!-- OLD - Now in Admin sub-tab -->
                </div>

                <!-- Customer Management Tab (Admin) -->
                <div id="customerManagementTab" class="tab-content" style="display: none;">
                    <!-- OLD - Now in Admin sub-tab -->
                </div>
                    
                    <div id="customerList"></div>
                </div>

                <!-- User Management Tab (Admin) -->
                <div id="userManagementTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #333;">User Management</h2>
                    <p style="margin-bottom: 20px; color: #666;">Create and manage customer accounts</p>
                    
                    <!-- Create New User Form -->
                    <div style="background: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: #333;">Create New Customer Account</h3>
                        <div id="userCreateAlert"></div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="newUserName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="newUserEmail" placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label>Phone *</label>
                                <input type="tel" id="newUserPhone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label>Company Name (Optional)</label>
                                <input type="text" id="newUserCompany" placeholder="Enter company name">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Address *</label>
                            <textarea id="newUserAddress" rows="2" placeholder="Enter full address"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Password *</label>
                                <input type="password" id="newUserPassword" placeholder="Create password">
                            </div>
                            <div class="form-group">
                                <label>Confirm Password *</label>
                                <input type="password" id="newUserPasswordConfirm" placeholder="Confirm password">
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="createNewUser()">âœ“ Create Customer Account</button>
                            <button class="btn btn-secondary" onclick="clearUserForm()" style="margin-left: 10px;">â†º Clear Form</button>
                        </div>
                    </div>
                    
                    <!-- Existing Users List -->
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: #333;">All Customer Accounts</h3>
                        <div id="usersList"></div>
                    </div>
                </div>

                <!-- Pricing Management Tab (Admin) -->
                <div id="pricingManagementTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #333;">Pricing Management</h2>
                    <p style="margin-bottom: 20px; color: #666;">Edit individual prices in the pricing tables. Changes apply immediately to new orders.</p>
                    
                    <div class="form-group">
                        <label>Select Fabric Group</label>
                        <select id="priceGroupSelect" onchange="loadPricingTable()">
                            <option value="1">Group 1</option>
                            <option value="2">Group 2</option>
                            <option value="3">Group 3</option>
                            <option value="4">Group 4</option>
                            <option value="5">Group 5</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="savePricing()">ðŸ’¾ Save Changes</button>
                        <button class="btn btn-secondary" onclick="resetPricing()">â†º Reset to Defaults</button>
                        <button class="btn btn-info" onclick="exportPricingToCSV()">ðŸ“¥ Export Pricing Table</button>
                    </div>

                    <div style="overflow-x: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <table id="pricingTable" style="width: 100%; border-collapse: collapse; min-width: 800px;">
                            <!-- Table will be populated by JavaScript -->
                        </table>
                    </div>

                    <div id="pricingAlert" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        #pricingTable th,
        #pricingTable td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        #pricingTable th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        #pricingTable tr:nth-child(even) {
            background: #f8f9fa;
        }

        #pricingTable tr:hover {
            background: #e9ecef;
        }

        #pricingTable input {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
        }

        #pricingTable input:focus {
            outline: none;
            border-color: #667eea;
            background: #f0f4ff;
        }

        #pricingTable .row-header {
            background: #e9ecef;
            font-weight: 600;
        }
    </style>

    <script>
        // Pricing data from Excel sheets
        const pricingData = {
            1: {
                600: {1200: 56.16, 1400: 58.24, 1600: 60.32, 1800: 62.4, 2000: 65.52, 2200: 68.64, 2400: 70.72, 2600: 72.8, 2800: 74.88, 3000: 78},
                800: {1200: 60.32, 1400: 62.4, 1600: 65.52, 1800: 68.64, 2000: 70.72, 2200: 72.8, 2400: 75.92, 2600: 79.04, 2800: 81.12, 3000: 83.2},
                1000: {1200: 62.4, 1400: 65.52, 1600: 68.64, 1800: 70.72, 2000: 72.8, 2200: 75.92, 2400: 79.04, 2600: 81.12, 2800: 83.2, 3000: 85.28},
                1200: {1200: 69.68, 1400: 71.76, 1600: 74.88, 1800: 78, 2000: 81.12, 2200: 83.2, 2400: 86.32, 2600: 89.44, 2800: 92.56, 3000: 95.68},
                1400: {1200: 74.88, 1400: 79.04, 1600: 82.16, 1800: 84.24, 2000: 87.36, 2200: 91.52, 2400: 95.68, 2600: 98.8, 2800: 102.96, 3000: 106.08},
                1600: {1200: 81.9, 1400: 85.05, 1600: 88.2, 1800: 92.4, 2000: 97.65, 2200: 100.8, 2400: 105, 2600: 108.15, 2800: 112.35, 3000: 116.55},
                1800: {1200: 88.2, 1400: 92.4, 1600: 97.65, 1800: 102.9, 2000: 106.05, 2200: 110.25, 2400: 115.5, 2600: 118.65, 2800: 123.9, 3000: 128.1},
                2000: {1200: 93.45, 1400: 98.7, 1600: 103.95, 1800: 108.15, 2000: 112.35, 2200: 117.6, 2400: 120.75, 2600: 127.05, 2800: 131.25, 3000: 135.45},
                2200: {1200: 116.55, 1400: 121.8, 1600: 128.1, 1800: 132.3, 2000: 138.6, 2200: 142.8, 2400: 147, 2600: 154.35, 2800: 158.55, 3000: 163.8},
                2400: {1200: 124.95, 1400: 131.25, 1600: 135.45, 1800: 141.75, 2000: 147, 2200: 153.3, 2400: 158.55, 2600: 164.85, 2800: 169.05, 3000: 175.35},
                2600: {1200: 154.76, 1400: 160.06, 1600: 166.42, 1800: 171.72, 2000: 178.08, 2200: 184.44, 2400: 190.8, 2600: 196.1, 2800: 202.46, 3000: 208.82},
                2800: {1200: 160.06, 1400: 167.48, 1600: 172.78, 1800: 180.2, 2000: 186.56, 2200: 192.92, 2400: 200.34, 2600: 205.64, 2800: 214.12, 3000: 219.42},
                3000: {1200: 163.24, 1400: 170.66, 1600: 178.08, 1800: 186.56, 2000: 193.98, 2200: 201.4, 2400: 209.88, 2600: 217.3, 2800: 224.72, 3000: 231.08}
            },
            2: {
                600: {1200: 62.4, 1400: 65.52, 1600: 68.64, 1800: 70.72, 2000: 72.8, 2200: 74.88, 2400: 78, 2600: 80.08, 2800: 81.12, 3000: 83.2},
                800: {1200: 66.56, 1400: 69.68, 1600: 72.8, 1800: 74.88, 2000: 78, 2200: 80.08, 2400: 82.16, 2600: 84.24, 2800: 89.44, 3000: 95.68},
                1000: {1200: 69.68, 1400: 72.8, 1600: 75.92, 1800: 79.04, 2000: 82.16, 2200: 85.28, 2400: 89.44, 2600: 91.52, 2800: 95.68, 3000: 98.8},
                1200: {1200: 75.92, 1400: 80.08, 1600: 83.2, 1800: 87.36, 2000: 91.52, 2200: 95.68, 2400: 99.84, 2600: 104, 2800: 107.12, 3000: 111.28},
                1400: {1200: 83.2, 1400: 87.36, 1600: 91.52, 1800: 96.72, 2000: 101.92, 2200: 106.08, 2400: 110.24, 2600: 114.4, 2800: 118.56, 3000: 123.76},
                1600: {1200: 91.35, 1400: 96.6, 1600: 100.8, 1800: 107.1, 2000: 111.3, 2200: 116.55, 2400: 121.8, 2600: 128.1, 2800: 132.3, 3000: 136.5},
                1800: {1200: 99.75, 1400: 106.05, 1600: 110.25, 1800: 117.6, 2000: 121.8, 2200: 129.15, 2400: 134.4, 2600: 139.65, 2800: 144.9, 3000: 152.25},
                2000: {1200: 106.05, 1400: 111.3, 1600: 117.6, 1800: 124.95, 2000: 131.25, 2200: 136.5, 2400: 142.8, 2600: 151.2, 2800: 156.45, 3000: 162.75},
                2200: {1200: 136.5, 1400: 143.85, 1600: 152.25, 1800: 157.5, 2000: 164.85, 2200: 171.15, 2400: 179.55, 2600: 186.9, 2800: 192.15, 3000: 198.45},
                2400: {1200: 145.95, 1400: 154.35, 1600: 162.75, 1800: 169.05, 2000: 176.4, 2200: 184.8, 2400: 192.15, 2600: 199.5, 2800: 206.85, 3000: 213.15},
                2600: {1200: 169.6, 1400: 177.02, 1600: 185.5, 1800: 193.98, 2000: 202.46, 2200: 210.94, 2400: 218.36, 2600: 226.84, 2800: 235.32, 3000: 243.8},
                2800: {1200: 177.02, 1400: 185.5, 1600: 195.04, 1800: 203.52, 2000: 213.06, 2200: 221.54, 2400: 230.02, 2600: 240.62, 2800: 246.98, 3000: 256.52},
                3000: {1200: 186.56, 1400: 195.04, 1600: 204.58, 1800: 215.18, 2000: 224.72, 2200: 233.2, 2400: 242.74, 2600: 252.28, 2800: 262.88, 3000: 271.36}
            },
            3: {
                600: {1200: 65.52, 1400: 68.64, 1600: 70.72, 1800: 73.84, 2000: 75.92, 2200: 81.12, 2400: 84.24, 2600: 87.36, 2800: 91.52, 3000: 95.68},
                800: {1200: 72.8, 1400: 75.92, 1600: 79.04, 1800: 82.16, 2000: 85.28, 2200: 89.44, 2400: 93.6, 2600: 97.76, 2800: 102.96, 3000: 107.12},
                1000: {1200: 74.88, 1400: 79.04, 1600: 83.2, 1800: 86.32, 2000: 91.52, 2200: 95.68, 2400: 99.84, 2600: 104, 2800: 108.16, 3000: 111.28},
                1200: {1200: 83.2, 1400: 87.36, 1600: 92.56, 1800: 97.76, 2000: 102.96, 2200: 107.12, 2400: 111.28, 2600: 117.52, 2800: 122.72, 3000: 127.92},
                1400: {1200: 91.52, 1400: 97.76, 1600: 102.96, 1800: 108.16, 2000: 114.4, 2200: 118.56, 2400: 125.84, 2600: 131.04, 2800: 137.28, 3000: 141.44},
                1600: {1200: 100.8, 1400: 107.1, 1600: 114.45, 1800: 119.7, 2000: 127.05, 2200: 133.35, 2400: 139.65, 2600: 144.9, 2800: 153.3, 3000: 158.55},
                1800: {1200: 110.25, 1400: 117.6, 1600: 124.95, 1800: 131.25, 2000: 139.65, 2200: 145.95, 2400: 154.35, 2600: 160.65, 2800: 168, 3000: 175.35},
                2000: {1200: 117.6, 1400: 124.95, 1600: 133.35, 1800: 141.75, 2000: 148.05, 2200: 157.5, 2400: 164.85, 2600: 172.2, 2800: 181.65, 3000: 113.4},
                2200: {1200: 142.8, 1400: 153.3, 1600: 160.65, 1800: 169.05, 2000: 178.5, 2200: 187.95, 2400: 195.3, 2600: 203.7, 2800: 213.15, 3000: 222.6},
                2400: {1200: 154.35, 1400: 163.8, 1600: 172.2, 1800: 182.7, 2000: 191.1, 2200: 200.55, 2400: 211.05, 2600: 219.45, 2800: 228.9, 3000: 239.4},
                2600: {1200: 185.5, 1400: 195.04, 1600: 205.64, 1800: 216.24, 2000: 226.84, 2200: 237.44, 2400: 246.98, 2600: 256.52, 2800: 268.18, 3000: 277.72},
                2800: {1200: 193.98, 1400: 204.58, 1600: 216.24, 1800: 227.9, 2000: 239.56, 2200: 250.16, 2400: 260.76, 2600: 271.36, 2800: 281.96, 3000: 294.68},
                3000: {1200: 204.58, 1400: 216.24, 1600: 227.9, 1800: 240.62, 2000: 252.28, 2200: 265, 2400: 275.6, 2600: 287.26, 2800: 299.98, 3000: 311.64}
            },
            4: {
                600: {1200: 70.72, 1400: 74.88, 1600: 78, 1800: 81.12, 2000: 84.24, 2200: 89.44, 2400: 93.6, 2600: 98.8, 2800: 102.96, 3000: 109.2},
                800: {1200: 78, 1400: 82.16, 1600: 87.36, 1800: 91.52, 2000: 95.68, 2200: 100.88, 2400: 105.04, 2600: 110.24, 2800: 114.4, 3000: 121.68},
                1000: {1200: 83.2, 1400: 89.44, 1600: 94.64, 1800: 99.84, 2000: 105.04, 2200: 111.28, 2400: 116.48, 2600: 121.68, 2800: 126.88, 3000: 133.12},
                1200: {1200: 93.6, 1400: 100.88, 1600: 106.08, 1800: 113.36, 2000: 120.64, 2200: 125.84, 2400: 133.12, 2600: 139.36, 2800: 145.6, 3000: 151.84},
                1400: {1200: 104, 1400: 111.28, 1600: 118.56, 1800: 126.88, 2000: 134.16, 2200: 141.44, 2400: 148.72, 2600: 157.04, 2800: 164.32, 3000: 171.6},
                1600: {1200: 115.5, 1400: 123.9, 1600: 133.35, 1800: 140.7, 2000: 150.15, 2200: 158.55, 2400: 168, 2600: 175.35, 2800: 184.8, 3000: 193.2},
                1800: {1200: 127.05, 1400: 136.5, 1600: 147, 1800: 156.45, 2000: 164.85, 2200: 175.35, 2400: 184.8, 2600: 195.3, 2800: 204.75, 3000: 214.2},
                2000: {1200: 136.5, 1400: 147, 1600: 157.5, 1800: 169.05, 2000: 179.55, 2200: 189, 2400: 199.5, 2600: 211.05, 2800: 221.55, 3000: 232.05},
                2200: {1200: 162.75, 1400: 174.3, 1600: 186.9, 1800: 198.45, 2000: 210, 2200: 221.55, 2400: 233.1, 2600: 245.7, 2800: 257.25, 3000: 268.8},
                2400: {1200: 175.35, 1400: 187.95, 1600: 200.55, 1800: 214.2, 2000: 226.8, 2200: 239.4, 2400: 252, 2600: 264.6, 2800: 278.25, 3000: 290.85},
                2600: {1200: 208.82, 1400: 222.6, 1600: 236.38, 1800: 251.22, 2000: 265, 2200: 278.78, 2400: 292.56, 2600: 306.34, 2800: 319.06, 3000: 333.9},
                2800: {1200: 219.42, 1400: 234.26, 1600: 249.1, 1800: 265, 2000: 279.84, 2200: 294.68, 2400: 309.52, 2600: 324.36, 2800: 339.2, 3000: 354.04},
                3000: {1200: 232.14, 1400: 246.98, 1600: 263.94, 1800: 279.84, 2000: 295.74, 2200: 312.7, 2400: 327.54, 2600: 344.5, 2800: 360.4, 3000: 376.3}
            },
            5: {
                600: {1200: 88.4, 1400: 93.6, 1600: 98.8, 1800: 105.04, 2000: 110.24, 2200: 115.44, 2400: 121.68, 2600: 125.84, 2800: 132.08, 3000: 137.28},
                800: {1200: 97.76, 1400: 102.96, 1600: 109.2, 1800: 116.48, 2000: 123.76, 2200: 132.08, 2400: 138.32, 2600: 145.6, 2800: 150.8, 3000: 160.16},
                1000: {1200: 99.84, 1400: 106.08, 1600: 114.4, 1800: 121.68, 2000: 128.96, 2200: 136.24, 2400: 143.52, 2600: 150.8, 2800: 158.08, 3000: 164.32},
                1200: {1200: 113.36, 1400: 121.68, 1600: 130, 1800: 138.32, 2000: 147.68, 2200: 156, 2400: 164.32, 2600: 173.68, 2800: 182, 3000: 191.36},
                1400: {1200: 125.84, 1400: 136.24, 1600: 146.64, 1800: 156, 2000: 166.4, 2200: 175.76, 2400: 186.16, 2600: 195.52, 2800: 205.92, 3000: 216.32},
                1600: {1200: 139.65, 1400: 151.2, 1600: 162.75, 1800: 174.3, 2000: 185.85, 2200: 197.4, 2400: 208.95, 2600: 220.5, 2800: 232.05, 3000: 243.6},
                1800: {1200: 153.3, 1400: 165.9, 1600: 179.55, 1800: 192.15, 2000: 205.8, 2200: 218.4, 2400: 231, 2600: 243.6, 2800: 256.2, 3000: 269.85},
                2000: {1200: 165.9, 1400: 181.65, 1600: 195.3, 1800: 208.95, 2000: 223.65, 2200: 238.35, 2400: 253.05, 2600: 266.7, 2800: 280.35, 3000: 296.1},
                2200: {1200: 197.4, 1400: 214.2, 1600: 228.9, 1800: 244.65, 2000: 261.45, 2200: 276.15, 2400: 291.9, 2600: 307.65, 2800: 323.4, 3000: 339.15},
                2400: {1200: 212.1, 1400: 229.95, 1600: 246.75, 1800: 264.6, 2000: 281.4, 2200: 298.2, 2400: 315, 2600: 332.85, 2800: 349.65, 3000: 367.5},
                2600: {1200: 251.22, 1400: 269.24, 1600: 288.32, 1800: 306.34, 2000: 325.42, 2200: 344.5, 2400: 362.52, 2600: 381.6, 2800: 399.62, 3000: 418.7},
                2800: {1200: 265, 1400: 284.08, 1600: 304.22, 1800: 325.42, 2000: 345.56, 2200: 364.64, 2400: 384.78, 2600: 404.92, 2800: 426.12, 3000: 445.2},
                3000: {1200: 279.84, 1400: 301.04, 1600: 323.3, 1800: 346.62, 2000: 364.64, 2200: 385.84, 2400: 409.16, 2600: 430.36, 2800: 451.56, 3000: 478.06}
            }
        };

        // Application State
        let currentUser = null;
        let blindItemCounter = 0;
        let quoteItemCounter = 0;
        let orders = [];
        let quotes = [];
        let currentOrderFilter = 'all';
        let currentProductFilter = 'all';

        // Initialize
        window.onload = function() {
            loadFromStorage();
            loadCustomPricing();
            initializeTestData();
            setDefaultDate();
            checkLogin();
        };

        function initializeTestData() {
            // Check if test data already exists
            const hasTestData = localStorage.getItem('testDataInitialized');
            if (hasTestData) return;

            // Create test users
            const testUsers = [
                {
                    id: 1001,
                    name: 'Sarah Johnson',
                    company: 'Elite Homes',
                    email: 'sarah@elitehomes.com',
                    phone: '0412 345 678',
                    address: '45 Collins Street, Melbourne VIC 3000',
                    password: 'test123',
                    role: 'customer'
                },
                {
                    id: 1002,
                    name: 'Michael Chen',
                    company: 'Chen Construction',
                    email: 'michael@chencon.com',
                    phone: '0423 456 789',
                    address: '128 Burke Road, Camberwell VIC 3124',
                    password: 'test123',
                    role: 'customer'
                },
                {
                    id: 1003,
                    name: 'Emma Williams',
                    company: '',
                    email: 'emma.w@gmail.com',
                    phone: '0434 567 890',
                    address: '22 Beach Road, Brighton VIC 3186',
                    password: 'test123',
                    role: 'customer'
                }
            ];

            // Create test orders
            const testOrders = [
                // Sarah's orders
                {
                    id: 1707100000001,
                    productType: 'blinds',
                    userId: 1001,
                    customerName: 'Sarah Johnson',
                    companyName: 'Elite Homes',
                    orderDate: '2026-01-15',
                    dateRequired: '2026-01-30',
                    items: [
                        {
                            type: 'blind',
                            location: 'Master Bedroom',
                            width: '2400',
                            drop: '2100',
                            group: '3',
                            fixing: 'Recess',
                            control: 'Right',
                            controlColour: 'White',
                            chain: 'Metal',
                            roll: 'Front',
                            fabric: 'Vintage',
                            colour: 'Pearl',
                            railType: 'D30/Square',
                            railColour: 'Anodised',
                            discount: '10',
                            price: '$146.39'
                        },
                        {
                            type: 'blind',
                            location: 'Living Room',
                            width: '3200',
                            drop: '2400',
                            group: '3',
                            fixing: 'Face',
                            control: 'Left',
                            controlColour: 'White',
                            chain: 'Metal',
                            roll: 'Front',
                            fabric: 'Vintage',
                            colour: 'Pearl',
                            railType: 'D30/Square',
                            railColour: 'Anodised',
                            discount: '10',
                            price: '$248.04'
                        }
                    ],
                    notes: 'Please install before end of month. Customer prefers morning installation.',
                    total: '$394.43',
                    status: 'confirmed',
                    createdAt: '2026-01-15T09:30:00.000Z'
                },
                {
                    id: 1707100000002,
                    productType: 'curtains',
                    userId: 1001,
                    customerName: 'Sarah Johnson',
                    companyName: 'Elite Homes',
                    orderDate: '2026-01-28',
                    dateRequired: '2026-02-15',
                    items: [
                        {
                            type: 'curtain',
                            location: 'Dining Room',
                            width: '3500',
                            drop: '2700',
                            dropDeducted: '2665',
                            curtainType: 'S Fold',
                            hem: '70mm',
                            fabric: 'Bali',
                            colour: 'Natural',
                            lining: '3 Pass - Ivory',
                            installation: 'Face',
                            bracketType: 'Wall',
                            trackType: 'Standard',
                            trackColour: 'White',
                            openingType: 'Centre',
                            wandSize: '1250',
                            itemNotes: '',
                            price: '$850.00'
                        }
                    ],
                    notes: 'Premium quality fabric requested',
                    total: '$850.00',
                    status: 'pending',
                    createdAt: '2026-01-28T14:20:00.000Z'
                },
                // Michael's orders
                {
                    id: 1707100000003,
                    productType: 'blinds',
                    userId: 1002,
                    customerName: 'Michael Chen',
                    companyName: 'Chen Construction',
                    orderDate: '2026-01-20',
                    dateRequired: '2026-02-05',
                    items: [
                        {
                            type: 'blind',
                            location: 'Office',
                            width: '1800',
                            drop: '2000',
                            group: '2',
                            fixing: 'Recess',
                            control: 'Right',
                            controlColour: 'Black',
                            chain: 'Stainless Steel',
                            roll: 'Front',
                            fabric: 'Sunscreen',
                            colour: 'Charcoal',
                            railType: 'D30/Square',
                            railColour: 'Black',
                            discount: '0',
                            price: '$121.80'
                        },
                        {
                            type: 'blind',
                            location: 'Conference Room',
                            width: '2800',
                            drop: '2200',
                            group: '2',
                            fixing: 'Face',
                            control: 'Left',
                            controlColour: 'Black',
                            chain: 'Stainless Steel',
                            roll: 'Front',
                            fabric: 'Sunscreen',
                            colour: 'Charcoal',
                            railType: 'D30/Square',
                            railColour: 'Black',
                            discount: '5',
                            price: '$210.46'
                        },
                        {
                            type: 'blind',
                            location: 'Reception',
                            width: '2400',
                            drop: '2400',
                            group: '2',
                            fixing: 'Recess',
                            control: 'Right',
                            controlColour: 'Black',
                            chain: 'Stainless Steel',
                            roll: 'Front',
                            fabric: 'Sunscreen',
                            colour: 'Charcoal',
                            railType: 'D30/Square',
                            railColour: 'Black',
                            discount: '5',
                            price: '$182.54'
                        }
                    ],
                    notes: 'Commercial installation - 5 x motors, 2 x remotes required',
                    total: '$514.80',
                    status: 'confirmed',
                    createdAt: '2026-01-20T11:45:00.000Z'
                },
                // Emma's order
                {
                    id: 1707100000004,
                    productType: 'curtains',
                    userId: 1003,
                    customerName: 'Emma Williams',
                    companyName: '',
                    orderDate: '2026-02-01',
                    dateRequired: '2026-02-10',
                    items: [
                        {
                            type: 'curtain',
                            location: 'Bedroom',
                            width: '2200',
                            drop: '2400',
                            dropDeducted: '2365',
                            curtainType: 'S Fold',
                            hem: '70mm',
                            fabric: 'Bali',
                            colour: 'Flax',
                            lining: 'No Lining',
                            installation: 'Face',
                            bracketType: 'Wall',
                            trackType: 'Standard',
                            trackColour: 'White',
                            openingType: 'Centre',
                            wandSize: '1000',
                            itemNotes: 'Match existing curtains in living room',
                            price: '$520.00'
                        },
                        {
                            type: 'curtain',
                            location: 'Guest Room',
                            width: '1600',
                            drop: '2100',
                            dropDeducted: '2065',
                            curtainType: 'Pencil Pleat',
                            hem: '80mm',
                            fabric: 'Linen',
                            colour: 'White',
                            lining: '3 Pass - White',
                            installation: 'Ceiling',
                            bracketType: 'Ceiling',
                            trackType: 'Standard',
                            trackColour: 'White',
                            openingType: 'Centre',
                            wandSize: '750',
                            itemNotes: '',
                            price: '$380.00'
                        }
                    ],
                    notes: '',
                    total: '$900.00',
                    status: 'pending',
                    createdAt: '2026-02-01T16:10:00.000Z'
                }
            ];

            // Save test data
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            const mergedUsers = [...existingUsers, ...testUsers];
            localStorage.setItem('users', JSON.stringify(mergedUsers));

            const existingOrders = JSON.parse(localStorage.getItem('blindOrders') || '[]');
            const mergedOrders = [...existingOrders, ...testOrders];
            localStorage.setItem('blindOrders', JSON.stringify(mergedOrders));

            // Load the test data into memory
            orders = mergedOrders;

            // Mark test data as initialized
            localStorage.setItem('testDataInitialized', 'true');

            console.log('Test data initialized: 3 customers, 4 orders');
        }

        function loadFromStorage() {
            const storedOrders = localStorage.getItem('blindOrders');
            if (storedOrders) {
                orders = JSON.parse(storedOrders);
            }
        }

        function loadCustomPricing() {
            const customPricing = localStorage.getItem('customPricing');
            if (customPricing) {
                const savedPricing = JSON.parse(customPricing);
                // Merge saved pricing with default pricing
                Object.keys(savedPricing).forEach(group => {
                    if (pricingData[group]) {
                        Object.keys(savedPricing[group]).forEach(width => {
                            if (pricingData[group][width]) {
                                Object.keys(savedPricing[group][width]).forEach(drop => {
                                    pricingData[group][width][drop] = savedPricing[group][width][drop];
                                });
                            }
                        });
                    }
                });
            }
        }

        function saveToStorage() {
            localStorage.setItem('blindOrders', JSON.stringify(orders));
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
        }

        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('loginAlert').innerHTML = '';
        }

        function showRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
            document.getElementById('registerAlert').innerHTML = '';
        }

        function register() {
            const name = document.getElementById('registerName').value.trim();
            const company = document.getElementById('registerCompany').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const address = document.getElementById('registerAddress').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!name || !email || !phone || !address || !password) {
                showAlert('registerAlert', 'Please fill in all required fields', 'error');
                return;
            }

            // Check if user exists
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.find(u => u.email === email)) {
                showAlert('registerAlert', 'Email already registered', 'error');
                return;
            }

            const newUser = {
                id: Date.now(),
                name,
                company,
                email,
                phone,
                address,
                password,
                role: 'customer'
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            showAlert('registerAlert', 'Account created successfully! Please login.', 'success');
            
            setTimeout(() => {
                showLogin();
            }, 1500);
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('loginAlert', 'Please enter email and password', 'error');
                return;
            }

            // Default admin account
            if (email === 'admin@signatureshades.com' && password === 'admin123') {
                currentUser = {
                    id: 0,
                    name: 'Admin',
                    email: email,
                    role: 'admin'
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                return;
            }

            // Check regular users
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                showAlert('loginAlert', 'Invalid email or password', 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfoSection').classList.remove('hidden');
            document.getElementById('currentUserName').textContent = currentUser.name;

            if (currentUser.role === 'admin') {
                document.getElementById('adminTabBtn').classList.remove('hidden');
            }

            addItem();
            loadMyOrders();
            loadAllOrders();
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type === 'error' ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            if (tabName === 'newOrder') {
                tabs[0].classList.add('active');
                document.getElementById('newOrderTab').classList.add('active');
            } else if (tabName === 'myOrders') {
                tabs[1].classList.add('active');
                document.getElementById('myOrdersTab').classList.add('active');
                loadMyOrders();
            } else if (tabName === 'quickQuote') {
                tabs[2].classList.add('active');
                document.getElementById('quickQuoteTab').classList.add('active');
                loadSavedQuotes();
            } else if (tabName === 'admin') {
                tabs[3].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                switchAdminSubTab('customerManagement');
            } else if (tabName === 'allOrders') {
                // Old - redirect to admin all orders tab
                tabs[3].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                switchAdminSubTab('allOrders');
            } else if (tabName === 'customerManagement') {
                // Old - redirect to admin
                switchTab('admin');
                switchAdminSubTab('customerManagement');
            } else if (tabName === 'userManagement') {
                // Old - redirect to admin
                switchTab('admin');
                switchAdminSubTab('userManagement');
            } else if (tabName === 'pricing') {
                // Old - redirect to admin
                switchTab('admin');
                switchAdminSubTab('pricing');
            }
        }

        function switchAdminSubTab(subTabName) {
            // Hide all admin sub-tabs
            document.querySelectorAll('.admin-sub-tab').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all admin sub-tab buttons
            document.querySelectorAll('#adminTab .order-filter-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected sub-tab
            const subTabMap = {
                'customerManagement': 'adminCustomerManagement',
                'userManagement': 'adminUserManagement',
                'pricing': 'adminPricing',
                'allOrders': 'adminAllOrders'
            };

            const selectedSubTab = document.getElementById(subTabMap[subTabName]);
            if (selectedSubTab) {
                selectedSubTab.style.display = 'block';
            }

            // Activate the button
            const buttons = document.querySelectorAll('#adminTab .order-filter-tab');
            buttons.forEach((btn, index) => {
                const subTabs = ['customerManagement', 'userManagement', 'pricing', 'allOrders'];
                if (subTabs[index] === subTabName) {
                    btn.classList.add('active');
                }
            });

            // Load data based on sub-tab
            if (subTabName === 'customerManagement') {
                loadCustomerManagement();
            } else if (subTabName === 'userManagement') {
                loadUserList();
            } else if (subTabName === 'pricing') {
                loadPricingTable();
            } else if (subTabName === 'allOrders') {
                loadAllOrders();
            }
        }


        function addItem() {
            const productType = document.getElementById('productType').value;
            if (productType === 'blinds') {
                addBlindItem();
            } else if (productType === 'curtains') {
                addCurtainItem();
            } else if (productType === 'shutters') {
                addShutterItem();
            }
        }

        function updateProductType() {
            const productType = document.getElementById('productType').value;
            const labels = {
                'blinds': 'Blind',
                'curtains': 'Curtain',
                'shutters': 'Shutter'
            };
            document.getElementById('itemTypeLabel').textContent = labels[productType] || 'Item';
            document.getElementById('addItemLabel').textContent = labels[productType] || 'Item';
            
            // Clear existing items when switching
            document.getElementById('blindItems').innerHTML = '';
            blindItemCounter = 0;
            updateTotals();
        }

        function addBlindItem() {
            blindItemCounter++;
            const container = document.getElementById('blindItems');
            
            const blindRow = document.createElement('div');
            blindRow.className = 'blind-row';
            blindRow.id = `blind-${blindItemCounter}`;
            
            blindRow.innerHTML = `
                <div class="blind-row-header">
                    <h4>Blind #${blindItemCounter}</h4>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="copyBlindItem(${blindItemCounter})" title="Copy this blind">ðŸ“‹ Copy</button>
                        <button class="btn btn-danger" onclick="removeBlindItem(${blindItemCounter})">Remove</button>
                    </div>
                </div>
                <div class="blind-fields">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" class="blind-location" placeholder="e.g., Living Room">
                    </div>
                    <div class="form-group">
                        <label>Width (mm)</label>
                        <input type="number" class="blind-width" onchange="calculatePrice(${blindItemCounter})">
                    </div>
                    <div class="form-group">
                        <label>Drop (mm)</label>
                        <input type="number" class="blind-drop" onchange="calculatePrice(${blindItemCounter})">
                    </div>
                    <div class="form-group">
                        <label>Fixing</label>
                        <input type="text" class="blind-fixing" placeholder="e.g., Face/Recess">
                    </div>
                    <div class="form-group">
                        <label>Bracket Type</label>
                        <select class="blind-bracket-type">
                            <option value="">Select...</option>
                            <option value="Single">Single</option>
                            <option value="Single Extension">Single Extension</option>
                            <option value="Dual Left">Dual Left</option>
                            <option value="Dual Right">Dual Right</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bracket Colour</label>
                        <select class="blind-bracket-colour">
                            <option value="">Select...</option>
                            <option value="White">White</option>
                            <option value="Black">Black</option>
                            <option value="Sandstone">Sandstone</option>
                            <option value="Barley">Barley</option>
                            <option value="Silver Grey">Silver Grey</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Control Side</label>
                        <select class="blind-control-side">
                            <option value="">Select...</option>
                            <option value="Left">Left</option>
                            <option value="Right">Right</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Chain or Motor</label>
                        <select class="blind-chain-motor">
                            <option value="">Select...</option>
                            <option value="TBS winder-32mm">TBS winder-32mm</option>
                            <option value="Acmeda winder-29mm">Acmeda winder-29mm</option>
                            <option value="Automate 1.1NM Li-Ion Quiet Motor">Automate 1.1NM Li-Ion Quiet Motor</option>
                            <option value="Automate 0.7NM Li-Ion Quiet Motor">Automate 0.7NM Li-Ion Quiet Motor</option>
                            <option value="Automate 2NM Li-Ion Quiet Motor">Automate 2NM Li-Ion Quiet Motor</option>
                            <option value="Automate 3NM Li-Ion Motor">Automate 3NM Li-Ion Motor</option>
                            <option value="Automate E6 6NM Motor">Automate E6 6NM Motor</option>
                            <option value="Alpha 1NM Battery Motor">Alpha 1NM Battery Motor</option>
                            <option value="Alpha 2NM Battery Motor">Alpha 2NM Battery Motor</option>
                            <option value="Alpha 3NM Battery Motor">Alpha 3NM Battery Motor</option>
                            <option value="Alpha AC 5NM Motor">Alpha AC 5NM Motor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Roll</label>
                        <select class="blind-roll">
                            <option value="">Select...</option>
                            <option value="Front">Front</option>
                            <option value="Back">Back</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select class="blind-material" onchange="updateFabricTypes(${blindItemCounter})">
                            <option value="">Select...</option>
                            <option value="Gracetech">Gracetech</option>
                            <option value="Textstyle">Textstyle</option>
                            <option value="Uniline">Uniline</option>
                            <option value="Vertex">Vertex</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fabric Type</label>
                        <select class="blind-fabric-type" onchange="updateFabricColours(${blindItemCounter})">
                            <option value="">Select material first...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fabric Colour</label>
                        <select class="blind-fabric-colour" onchange="calculatePrice(${blindItemCounter})">
                            <option value="">Select fabric type first...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bottom Rail Type</label>
                        <select class="blind-rail-type">
                            <option value="">Select...</option>
                            <option value="D30/Oval">D30/Oval</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bottom Rail Colour</label>
                        <select class="blind-rail-colour">
                            <option value="">Select...</option>
                            <option value="Anodised">Anodised</option>
                            <option value="Black">Black</option>
                            <option value="Bone">Bone</option>
                            <option value="Dune">Dune</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Discount (%) <span class="discount-badge" id="discount-badge-${blindItemCounter}" style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">Auto</span></label>
                        <input type="number" class="blind-discount" min="0" max="100" value="0" readonly style="background: #e9ecef;" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Price</label>
                        <input type="text" class="blind-price" readonly style="background: #e9ecef; font-weight: bold;">
                    </div>
                </div>
            `;
            
            container.appendChild(blindRow);
            updateTotals();
        }

        // Fabric data from JSON (excluding G4 and G5)
        const fabricData = {"Gracetech":{"Platinum P05":{"group":"G1","colors":["2001 White","2002 White Beige","2003 White Grey","2004 Beige","2005 Beige Grey","2006 Grey","2007 Black Grey","2009 Black","2050 White Pearl","2066 Super White","2067 Charcoal Grey","2079 Charcoal","2080 caramel","2081 Casper","2082 Fudge","2083 Hammer","2084 Cloud Grey","2098A Black Copper"]},"Platinum P10":{"group":"G1","colors":["2001 White","2002 White Beige","2003 White Grey","2004 Beige","2005 Beige Grey","2006 Grey","2007 Black Grey","2009 Black","2050 White Pearl","2066 Super White","2067 Charcoal Grey","2079 Charcoal","2080 caramel","2081 Casper","2082 Fudge","2083 Hammer","2084 Cloud Grey","2098A Black Copper"]}},"Textstyle":{"Balmoral Blockout":{"group":"G3","colors":["Armour","Birch","Bourneville","Chrome","Concrete","Dove","Jet","Pearl","Platinum","Putty","Pyrite","Steel","White"]},"Balmoral Light Filtering":{"group":"G3","colors":["Armour","Birch","Bourneville","Chrome","Concrete","Dove","Jet","Pearl","Platinum","Putty","Pyrite","Steel","White"]},"Cascata":{"group":"G2","colors":["Ardesia","Avorio","Baltico","Corvo","Grigio","Mercurio","Neve","Nuvola","Pepe"]},"Focus":{"group":"G1","colors":["Alabaster","Almond","Ash","Bay","Beechwood","Carbon","Chalk","Cloud","Coal","Cotton","Dove","Drift","Duck Egg","Ebony","Espresso","Eucalypt","Feather","Fig","Jarrah","Latte","Linen","Magnetic","Mist","Oyster","Polar","Powder","Putty","Sandstone","Shell","Smoke","Stone","Tempest","White"]},"Jersey Blockout":{"group":"G3","colors":["Ashen","Basalt","Cinder","Ember","Lace","Mink","Opal","Render","Sable","Willow"]},"Jersey Light Filtering":{"group":"G3","colors":["Ashen","Basalt","Cinder","Ember","Lace","Mink","Opal","Render","Sable","Willow"]},"Kleenscreen":{"group":"G2","colors":["Alloy","Barley","Black","Black Pearl","Charcoal","Graphite","Ivory","Pewter","Pumice","Pure White","Shale"]},"Kleenscreen Blockout":{"group":"G2","colors":["Alloy","Barley","Black","Black Pearl","Charcoal","Ice","Pewter","Pumice"]},"Metroshade Blockout":{"group":"G3","colors":["Black","Dove/White","Ecru","Ice Grey","Moonstone","Nougat","Pebble","Quill","Seal","Slate","Storm","Whitewash"]},"Metroshade Light Filtering":{"group":"G3","colors":["Dove/White","Ecru","Ice Grey","Moonstone","Nougat","Quill"]},"One Screen":{"group":"G2","colors":["Black","Charcoal","Dune","Grey","Gunmetal","Ice","Linen/Bronze","Mercury","Sand","Silver/Black","Wallaby","White"]},"Sanctuary Blockout":{"group":"G2","colors":["Baltic","Ceramic","Fossil","Lava","Limestone","Marble","Mineral","Plaster","Slate","Suede","Truffle"]},"Sanctuary Light Filtering":{"group":"G2","colors":["Baltic","Ceramic","Fossil","Lava","Limestone","Marble","Mineral","Plaster","Slate","Suede","Truffle"]}},"Uniline":{"Dawn":{"group":"G1","colors":["Alabaster","Arum","Ash Blue","Beige","Bison","BK RB08","Buttercream","Cameo","Champagne","Cloud","Coastline","Cocoa","Cosmos","Dusty Rose","Haze","Lagoon","Latte","Natural","Parchment","Pebble","RawHide","Sepia","Shale","Tan","Thunder Cloud","White"]},"Sunset":{"group":"G1","colors":["Antique","Ash Grey","Bark","Beaver","Bone","Cashew","Ecru","Flax","Lace","Lava","Mushroom","Natural","Onyx","parchment","Pepper","Sahara","Seal","Silver","Snow","Stone","Taupe","Vanila","Warm Grey"]},"Tapestry Blockout":{"group":"G2","colors":["Buff","Cloud","Concrete","Dove","Gunmetal","Portland","Seagull","Tuxedo","White Wash"]},"Tapestry Light Filtering":{"group":"G2","colors":["Buff","Cloud","Concrete","Dove","Gunmetal","Portland","Seagull","Tuxedo","White Wash"]}},"Vertex":{"Iguzu":{"group":"G2","colors":["1901","1902","1903","1904","1905","1906"]},"Vale Blockout":{"group":"G2","colors":["Apricote","Arctic","Cobalt","Dove","Graphite","Greige","Hazel","Misty","Pale Gray","Vanilla","White"]},"Vale Light Filtering":{"group":"G2","colors":["Apricote","Arctic","Cobalt","Dove","Graphite","Greige","Hazel","Misty","Pale Gray","Vanilla","White"]},"Vegan Block Out":{"group":"G2","colors":["Clover","Jasmine","Tansy","Tulip","Willow"]},"Vegas Blockout":{"group":"G2","colors":["Boulder","Bunflow","Caring Tan","Cotton","Darkwood","Sand Dan"]},"Vegas Light Filtering":{"group":"G2","colors":["Boulder","Bunflow","Caring Tan","Cotton","Darkwood","Sand Dan"]},"Velvet Block Out":{"group":"G2","colors":["Blush","Chalk","Mist","Shell","Whisper"]},"Venus Block Out":{"group":"G2","colors":["Dove","Ebony","Granite","Linen","Pearl","Snow","Stone"]},"Venus Light Filtering":{"group":"G2","colors":["Linen","Pearl","Snow"]},"Verdure Block Out":{"group":"G2","colors":["Charcoal","Cystal","Ecru","Flint","Fog","Midnight","Mist","Onyx","Pebble","Rainforest","Silver","Tan"]},"Verdure Light Filter":{"group":"G2","colors":["Charcoal","Crystal","Ecru","Flint","Fog","Mist","Onyx","Pebble","Rainforest","Silver","Tan"]},"Vermont Block Out":{"group":"G2","colors":["Alabaster","Anchor","Denim","Fog","Fossil","Onyx","Pewter","White"]},"Verne Blockout":{"group":"G2","colors":["Abalone","Achor","River","Smoke","Steel","White"]},"Verne Light Filtering":{"group":"G2","colors":["Abalone","Achor","River","Smoke","Steel","White"]},"Verona Block Out":{"group":"G2","colors":["Beige","Black","Gold","Grey","Off White","White"]},"Verona Plus Block Out":{"group":"G2","colors":["Beige","Black","Gold","Grey","Off White","White"]},"Versatile Block Out":{"group":"G1","colors":["Alloy","Alloy RB08","Bark","Bark RB08","Chrome","Chrome RB08","Cloud","Cloud RB08","Coal","Coal RB08","Coffon","Coffon RB08","Dusk","Dusk RB08","Ebony","Ebony RB08","Gardenia","Gardenia RB08","Gravel","Gravel RB08","Ice","Ice RB08","Lava","Lava RB08","Leather","Leather RB08","Luna","Luna RB08","Mocha","Mocha RB08","Natural","Natural RB08","Oyster","Oyster RB08","Peach","Peach RB08","Pine","Pine RB08","Seal","Seal RB08","Stone","Stone RB08","Taupe","Taupe RB08","Thunder","Thunder RB08","Wheat","Wheat RB08"]},"Victoria Block Out":{"group":"G2","colors":["Chrome","Crema","Eucalyptus","Grey","Leather","Mont Blanc","Natural","Pure Black","Putty","Snow White","Steel"]},"Vintage Block Out":{"group":"G2","colors":["Almond","Blush","Chalk","Cloud","Espresso","Jarrah","Oyster"]},"Vintage Light Filtering":{"group":"G2","colors":["Almond","Blush","Chalk","Cloud","Espresso","Jarrah","Oyster"]},"Vision":{"group":"G2","colors":["Beige","Beige RB08","Black","Black RB08","Charcoal","Copper","Dark Pearl","Grey","Grey RB08","Ice","Ice RB08","Light Grey","Sand","White","White RB08"]},"Vista Block Out":{"group":"G2","colors":["Ash","Bone","Daisy","Ivory","Lace","Silver","Slate","Smoke","Storm"]},"Vista Light Filter":{"group":"G2","colors":["Ash","Bone","Daisy","Ivory","Lace","Silver","Slate","Smoke","Storm"]},"Vital Block Out":{"group":"G2","colors":["Atlantic Salt","Fog White","Jet Black","Ocean Foam","Sandstone","Slate Grey"]},"Vital Light Filter":{"group":"G2","colors":["Atlantic Salt","Fog White","Jet Black","Ocean Foam","Sandstone","Slate Grey"]},"Voltas Blockout":{"group":"G2","colors":["Beige","Cream","Mink","Silver Grey","Stone","White"]},"Voltas Light Filtering":{"group":"G2","colors":["Beige","Cream","Mink","Silver Grey","Stone","White"]}}};

        // Copy blind function
        function copyBlindItem(blindId) {
            const sourceRow = document.getElementById(`blind-${blindId}`);
            if (!sourceRow) return;
            
            blindItemCounter++;
            const container = document.getElementById('blindItems');
            
            // Create new blind
            const newRow = document.createElement('div');
            newRow.className = 'blind-row';
            newRow.id = `blind-${blindItemCounter}`;
            
            // Copy HTML structure
            newRow.innerHTML = sourceRow.innerHTML
                .replace(new RegExp(`blind-${blindId}`, 'g'), `blind-${blindItemCounter}`)
                .replace(new RegExp(`\\(${blindId}\\)`, 'g'), `(${blindItemCounter})`)
                .replace(new RegExp(`discount-badge-${blindId}`, 'g'), `discount-badge-${blindItemCounter}`)
                .replace(`Blind #${blindId}`, `Blind #${blindItemCounter}`);
            
            container.appendChild(newRow);
            
            // Copy all field values EXCEPT Location, Width, and Drop
            const fieldsToCopy = ['blind-fixing', 'blind-bracket-type', 'blind-bracket-colour', 'blind-control-side', 
                                 'blind-chain-motor', 'blind-roll', 'blind-material', 'blind-fabric-type', 
                                 'blind-fabric-colour', 'blind-rail-type', 'blind-rail-colour'];
            
            fieldsToCopy.forEach(fieldClass => {
                const sourceValue = sourceRow.querySelector(`.${fieldClass}`).value;
                newRow.querySelector(`.${fieldClass}`).value = sourceValue;
            });
            
            // Clear Location, Width, Drop
            newRow.querySelector('.blind-location').value = '';
            newRow.querySelector('.blind-width').value = '';
            newRow.querySelector('.blind-drop').value = '';
            newRow.querySelector('.blind-price').value = '';
            
            // Update fabric dropdowns if material was copied
            const material = newRow.querySelector('.blind-material').value;
            if (material) {
                updateFabricTypes(blindItemCounter);
                setTimeout(() => {
                    const fabricType = newRow.querySelector('.blind-fabric-type').value;
                    if (fabricType) {
                        updateFabricColours(blindItemCounter);
                    }
                }, 100);
            }
            
            updateTotals();
            showAlert('orderAlert', 'âœ“ Blind copied! Please update Location, Width, and Drop.', 'success');
        }

        // Update fabric types based on material selection
        function updateFabricTypes(blindId) {
            const row = document.getElementById(`blind-${blindId}`);
            if (!row) return;
            
            const material = row.querySelector('.blind-material').value;
            const fabricTypeSelect = row.querySelector('.blind-fabric-type');
            const fabricColourSelect = row.querySelector('.blind-fabric-colour');
            
            fabricTypeSelect.innerHTML = '<option value="">Select...</option>';
            fabricColourSelect.innerHTML = '<option value="">Select fabric type first...</option>';
            
            if (material && fabricData[material]) {
                Object.keys(fabricData[material]).forEach(fabricType => {
                    const option = document.createElement('option');
                    option.value = fabricType;
                    option.textContent = fabricType;
                    fabricTypeSelect.appendChild(option);
                });
            }
        }

        // Update fabric colours based on fabric type selection
        function updateFabricColours(blindId) {
            const row = document.getElementById(`blind-${blindId}`);
            if (!row) return;
            
            const material = row.querySelector('.blind-material').value;
            const fabricType = row.querySelector('.blind-fabric-type').value;
            const fabricColourSelect = row.querySelector('.blind-fabric-colour');
            
            fabricColourSelect.innerHTML = '<option value="">Select...</option>';
            
            if (material && fabricType && fabricData[material][fabricType]) {
                const colours = fabricData[material][fabricType].colors;
                colours.forEach(colour => {
                    const option = document.createElement('option');
                    option.value = colour;
                    option.textContent = colour;
                    fabricColourSelect.appendChild(option);
                });
                
                // Update discount when fabric type changes
                updateDiscountForBlind(blindId);
            }
        }

        // Update discount based on fabric group and calculate price
        function updateDiscountForBlind(blindId) {
            const row = document.getElementById(`blind-${blindId}`);
            if (!row) return;
            
            const material = row.querySelector('.blind-material').value;
            const fabricType = row.querySelector('.blind-fabric-type').value;
            const discountInput = row.querySelector('.blind-discount');
            const discountBadge = document.getElementById(`discount-badge-${blindId}`);
            
            if (material && fabricType && fabricData[material][fabricType]) {
                const group = fabricData[material][fabricType].group;
                
                // Map G1, G2, G3 to pricing groups 1, 2, 3
                const groupMapping = {'G1': 1, 'G2': 2, 'G3': 3};
                const pricingGroup = groupMapping[group];
                
                // Default discounts: G1=20%, G2=25%, G3=30%
                const defaultDiscounts = {1: 20, 2: 25, 3: 30};
                const discount = defaultDiscounts[pricingGroup] || 0;
                
                discountInput.value = discount;
                discountBadge.textContent = `${group}: ${discount}%`;
                
                // Store the pricing group as a data attribute for price calculation
                row.dataset.pricingGroup = pricingGroup;
            } else {
                discountInput.value = 0;
                discountBadge.textContent = 'Auto';
                delete row.dataset.pricingGroup;
            }
            
            calculatePrice(blindId);
        }

        function toggleMotorOptions(itemId) {
            const row = document.getElementById(`blind-${itemId}`);
            if (!row) return;
            
            const controlType = row.querySelector('.blind-control-type').value;
            const motorTypeGroup = row.querySelector('.blind-motor-type-group');
            
            if (controlType === 'Motor') {
                motorTypeGroup.style.display = 'block';
            } else {
                motorTypeGroup.style.display = 'none';
                // Clear motor selection if not motor
                row.querySelector('.blind-motor-type').value = '';
            }
        }

        function removeBlindItem(id) {
            document.getElementById(`blind-${id}`).remove();
            updateTotals();
        }

        function addCurtainItem() {
            blindItemCounter++;
            const container = document.getElementById('blindItems');
            
            const curtainRow = document.createElement('div');
            curtainRow.className = 'blind-row';
            curtainRow.id = `blind-${blindItemCounter}`;
            curtainRow.dataset.type = 'curtain';
            
            curtainRow.innerHTML = `
                <div class="blind-row-header">
                    <h4>Curtain #${blindItemCounter}</h4>
                    <button class="btn btn-danger" onclick="removeBlindItem(${blindItemCounter})">Remove</button>
                </div>
                <div class="blind-fields">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" class="curtain-location" placeholder="e.g., Living Room">
                    </div>
                    <div class="form-group">
                        <label>Width (mm)</label>
                        <input type="number" class="curtain-width" placeholder="Width">
                    </div>
                    <div class="form-group">
                        <label>Drop (mm)</label>
                        <input type="number" class="curtain-drop" placeholder="Drop">
                    </div>
                    <div class="form-group">
                        <label>After Deductions Drop (mm)</label>
                        <input type="number" class="curtain-drop-deducted" placeholder="After deductions">
                    </div>
                    <div class="form-group">
                        <label>Curtain Type</label>
                        <select class="curtain-type">
                            <option value="">Select...</option>
                            <option value="S Fold">S Fold</option>
                            <option value="Pencil Pleat">Pencil Pleat</option>
                            <option value="Eyelet">Eyelet</option>
                            <option value="Wave">Wave</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hem</label>
                        <select class="curtain-hem">
                            <option value="">Select...</option>
                            <option value="No Hem">No Hem</option>
                            <option value="70mm">70mm</option>
                            <option value="80mm">80mm</option>
                            <option value="100mm">100mm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fabric</label>
                        <input type="text" class="curtain-fabric" placeholder="e.g., Bali">
                    </div>
                    <div class="form-group">
                        <label>Colour</label>
                        <input type="text" class="curtain-colour" placeholder="e.g., Flax">
                    </div>
                    <div class="form-group">
                        <label>Lining</label>
                        <select class="curtain-lining">
                            <option value="">Select...</option>
                            <option value="No Lining">No Lining</option>
                            <option value="3 Pass - Ivory">3 Pass - Ivory</option>
                            <option value="3 Pass - White">3 Pass - White</option>
                            <option value="Blockout">Blockout</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Installation</label>
                        <select class="curtain-installation">
                            <option value="">Select...</option>
                            <option value="Face">Face</option>
                            <option value="Ceiling">Ceiling</option>
                            <option value="Other - See Notes">Other - See Notes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bracket Type</label>
                        <select class="curtain-bracket">
                            <option value="">Select...</option>
                            <option value="Wall">Wall</option>
                            <option value="Ceiling">Ceiling</option>
                            <option value="Other - See Notes">Other - See Notes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Track Type</label>
                        <select class="curtain-track-type">
                            <option value="">Select...</option>
                            <option value="Standard">Standard</option>
                            <option value="Extended">Extended</option>
                            <option value="Heavy Duty">Heavy Duty</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Track Colour</label>
                        <select class="curtain-track-colour">
                            <option value="">Select...</option>
                            <option value="White">White</option>
                            <option value="Anodised">Anodised</option>
                            <option value="Black">Black</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Opening Type</label>
                        <select class="curtain-opening">
                            <option value="">Select...</option>
                            <option value="Centre">Centre</option>
                            <option value="RH Stack">RH Stack</option>
                            <option value="LH Stack">LH Stack</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Wand Size (mm)</label>
                        <select class="curtain-wand">
                            <option value="">Select...</option>
                            <option value="750">750mm</option>
                            <option value="1000">1000mm</option>
                            <option value="1250">1250mm</option>
                            <option value="1500">1500mm</option>
                            <option value="1750">1750mm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Notes</label>
                        <input type="text" class="curtain-notes" placeholder="Special instructions">
                    </div>
                    <div class="form-group">
                        <label>Price (Optional)</label>
                        <input type="text" class="curtain-price" placeholder="$0.00">
                    </div>
                </div>
            `;
            
            container.appendChild(curtainRow);
            updateTotals();
        }

        function addShutterItem() {
            blindItemCounter++;
            const container = document.getElementById('blindItems');
            
            const shutterRow = document.createElement('div');
            shutterRow.className = 'blind-row';
            shutterRow.id = `blind-${blindItemCounter}`;
            shutterRow.dataset.type = 'shutter';
            
            shutterRow.innerHTML = `
                <div class="blind-row-header">
                    <h4>Plantation Shutter #${blindItemCounter}</h4>
                    <button class="btn btn-danger" onclick="removeBlindItem(${blindItemCounter})">Remove</button>
                </div>
                <div class="blind-fields">
                    <div class="form-group">
                        <label>Room</label>
                        <input type="text" class="shutter-room" placeholder="e.g., Bed 1">
                    </div>
                    <div class="form-group">
                        <label>Width (mm)</label>
                        <input type="number" class="shutter-width" placeholder="Width">
                    </div>
                    <div class="form-group">
                        <label>Drop (mm)</label>
                        <input type="number" class="shutter-drop" placeholder="Drop">
                    </div>
                    <div class="form-group">
                        <label>Mid Rail</label>
                        <select class="shutter-midrail">
                            <option value="">Select...</option>
                            <option value="No mid">No mid</option>
                            <option value="Mid Rail">Mid Rail</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Panels</label>
                        <input type="number" class="shutter-panels" placeholder="Number of panels">
                    </div>
                    <div class="form-group">
                        <label>Layout Code</label>
                        <select class="shutter-layout">
                            <option value="">Select Layout...</option>
                            <option value="L">L</option>
                            <option value="R">R</option>
                            <option value="L-L">L-L</option>
                            <option value="R-R">R-R</option>
                            <option value="L-R">L-R</option>
                            <option value="L-DR">L-DR</option>
                            <option value="DL-R">DL-R</option>
                            <option value="L-L-R">L-L-R</option>
                            <option value="L-R-R">L-R-R</option>
                            <option value="DL-DR">DL-DR</option>
                            <option value="L-L-R-R">L-L-R-R</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Frame Code</label>
                        <input type="text" class="shutter-framecode" placeholder="e.g., L50">
                    </div>
                    <div class="form-group">
                        <label>Frame Style</label>
                        <select class="shutter-framestyle">
                            <option value="">Select...</option>
                            <option value="Flat">Flat</option>
                            <option value="Raised">Raised</option>
                            <option value="Shaker">Shaker</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Frame Request</label>
                        <select class="shutter-framerequest">
                            <option value="">Select...</option>
                            <option value="All 4 frames">All 4 frames</option>
                            <option value="No bottom frame">No bottom frame</option>
                            <option value="No frame">No frame</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select class="shutter-material">
                            <option value="">Select...</option>
                            <option value="Thermoline">Thermoline</option>
                            <option value="Basswood">Basswood</option>
                            <option value="PVC">PVC</option>
                            <option value="MDF">MDF</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Color Code</label>
                        <input type="text" class="shutter-colorcode" placeholder="e.g., Pure white M001">
                    </div>
                    <div class="form-group">
                        <label>Louver Size</label>
                        <select class="shutter-louversize">
                            <option value="">Select...</option>
                            <option value="63mm">63mm</option>
                            <option value="89mm">89mm</option>
                            <option value="114mm">114mm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price (Optional)</label>
                        <input type="text" class="shutter-price" placeholder="$0.00">
                    </div>
                </div>
            `;
            
            container.appendChild(shutterRow);
            updateTotals();
        }



        function calculatePrice(id) {
            const row = document.getElementById(`blind-${id}`);
            const width = parseInt(row.querySelector('.blind-width').value);
            const drop = parseInt(row.querySelector('.blind-drop').value);
            const discount = parseFloat(row.querySelector('.blind-discount').value) || 0;
            
            // Get pricing group from the data attribute set by fabric selection
            const group = parseInt(row.dataset.pricingGroup);

            if (width && drop && group) {
                let price = getPrice(width, drop, group);
                
                if (price) {
                    // Apply discount
                    if (discount > 0) {
                        price = price * (1 - discount / 100);
                    }
                    row.querySelector('.blind-price').value = `$${price.toFixed(2)}`;
                } else {
                    row.querySelector('.blind-price').value = 'N/A';
                }
            } else {
                row.querySelector('.blind-price').value = '';
            }

            updateTotals();
        }

        function getPrice(width, drop, group) {
            if (!pricingData[group]) return null;

            // Get available widths and drops
            const widths = Object.keys(pricingData[group]).map(Number).sort((a, b) => a - b);
            const firstWidth = widths[0];
            const drops = Object.keys(pricingData[group][firstWidth]).map(Number).sort((a, b) => a - b);

            // Find closest width by rounding to nearest (round up if exactly in middle)
            let closestWidth = widths[0];
            let minWidthDiff = Math.abs(width - widths[0]);
            
            for (let w of widths) {
                const diff = Math.abs(width - w);
                if (diff < minWidthDiff || (diff === minWidthDiff && w > closestWidth)) {
                    minWidthDiff = diff;
                    closestWidth = w;
                }
            }

            // Find closest drop by rounding to nearest (round up if exactly in middle)
            let closestDrop = drops[0];
            let minDropDiff = Math.abs(drop - drops[0]);
            
            for (let d of drops) {
                const diff = Math.abs(drop - d);
                if (diff < minDropDiff || (diff === minDropDiff && d > closestDrop)) {
                    minDropDiff = diff;
                    closestDrop = d;
                }
            }

            return pricingData[group][closestWidth][closestDrop];
        }

        function updateTotals() {
            const blindRows = document.querySelectorAll('.blind-row');
            let count = 0;
            let total = 0;

            blindRows.forEach(row => {
                if (row.dataset.type === 'curtain') {
                    // Curtain item
                    const priceText = row.querySelector('.curtain-price').value;
                    if (priceText) {
                        count++;
                        const priceValue = parseFloat(priceText.replace('$', '').replace(',', ''));
                        if (!isNaN(priceValue)) {
                            total += priceValue;
                        }
                    }
                } else if (row.dataset.type === 'shutter') {
                    // Shutter item
                    const priceText = row.querySelector('.shutter-price').value;
                    if (priceText) {
                        count++;
                        const priceValue = parseFloat(priceText.replace('$', '').replace(',', ''));
                        if (!isNaN(priceValue)) {
                            total += priceValue;
                        }
                    }
                } else {
                    // Blind item
                    const priceText = row.querySelector('.blind-price').value;
                    if (priceText && priceText !== 'N/A') {
                        count++;
                        total += parseFloat(priceText.replace('$', ''));
                    }
                }
            });

            document.getElementById('totalBlinds').textContent = count;
            document.getElementById('subtotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `$${total.toFixed(2)}`;
        }

        function submitOrder() {
            const productType = document.getElementById('productType').value;
            const blindRows = document.querySelectorAll('.blind-row');
            const items = [];

            blindRows.forEach(row => {
                if (row.dataset.type === 'curtain') {
                    // Curtain item
                    const width = row.querySelector('.curtain-width').value;
                    const drop = row.querySelector('.curtain-drop').value;
                    
                    if (width && drop) {
                        items.push({
                            type: 'curtain',
                            location: row.querySelector('.curtain-location').value,
                            width: width,
                            drop: drop,
                            dropDeducted: row.querySelector('.curtain-drop-deducted').value,
                            curtainType: row.querySelector('.curtain-type').value,
                            hem: row.querySelector('.curtain-hem').value,
                            fabric: row.querySelector('.curtain-fabric').value,
                            colour: row.querySelector('.curtain-colour').value,
                            lining: row.querySelector('.curtain-lining').value,
                            installation: row.querySelector('.curtain-installation').value,
                            bracketType: row.querySelector('.curtain-bracket').value,
                            trackType: row.querySelector('.curtain-track-type').value,
                            trackColour: row.querySelector('.curtain-track-colour').value,
                            openingType: row.querySelector('.curtain-opening').value,
                            wandSize: row.querySelector('.curtain-wand').value,
                            itemNotes: row.querySelector('.curtain-notes').value,
                            price: row.querySelector('.curtain-price').value
                        });
                    }
                } else if (row.dataset.type === 'shutter') {
                    // Shutter item
                    const width = row.querySelector('.shutter-width').value;
                    const drop = row.querySelector('.shutter-drop').value;
                    
                    if (width && drop) {
                        items.push({
                            type: 'shutter',
                            room: row.querySelector('.shutter-room').value,
                            width: width,
                            drop: drop,
                            midRail: row.querySelector('.shutter-midrail').value,
                            panels: row.querySelector('.shutter-panels').value,
                            layoutCode: row.querySelector('.shutter-layout').value,
                            frameCode: row.querySelector('.shutter-framecode').value,
                            frameStyle: row.querySelector('.shutter-framestyle').value,
                            frameRequest: row.querySelector('.shutter-framerequest').value,
                            material: row.querySelector('.shutter-material').value,
                            colorCode: row.querySelector('.shutter-colorcode').value,
                            louverSize: row.querySelector('.shutter-louversize').value,
                            price: row.querySelector('.shutter-price').value
                        });
                    }
                } else {
                    // Blind item
                    const width = row.querySelector('.blind-width').value;
                    const drop = row.querySelector('.blind-drop').value;
                    
                    if (width && drop) {
                        items.push({
                            type: 'blind',
                            location: row.querySelector('.blind-location').value,
                            width: width,
                            drop: drop,
                            fixing: row.querySelector('.blind-fixing').value,
                            bracketType: row.querySelector('.blind-bracket-type').value,
                            bracketColour: row.querySelector('.blind-bracket-colour').value,
                            controlSide: row.querySelector('.blind-control-side').value,
                            chainMotor: row.querySelector('.blind-chain-motor').value,
                            roll: row.querySelector('.blind-roll').value,
                            material: row.querySelector('.blind-material').value,
                            fabricType: row.querySelector('.blind-fabric-type').value,
                            fabricColour: row.querySelector('.blind-fabric-colour').value,
                            railType: row.querySelector('.blind-rail-type').value,
                            railColour: row.querySelector('.blind-rail-colour').value,
                            discount: row.querySelector('.blind-discount').value || '0',
                            price: row.querySelector('.blind-price').value,
                            group: row.dataset.pricingGroup || ''
                        });
                    }
                }
            });

            if (items.length === 0) {
                showAlert('orderAlert', 'Please add at least one item', 'error');
                return;
            }

            const order = {
                id: Date.now(),
                productType: productType,
                userId: currentUser.id,
                customerName: currentUser.name,
                companyName: currentUser.company || '',
                orderDate: document.getElementById('orderDate').value,
                dateRequired: document.getElementById('dateRequired').value,
                items: items,
                notes: document.getElementById('additionalNotes').value,
                total: document.getElementById('grandTotal').textContent,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            orders.push(order);
            saveToStorage();

            showAlert('orderAlert', 'Order submitted successfully!', 'success');
            
            setTimeout(() => {
                // Reset form
                document.getElementById('blindItems').innerHTML = '';
                blindItemCounter = 0;
                document.getElementById('additionalNotes').value = '';
                setDefaultDate();
                document.getElementById('dateRequired').value = '';
                addItem();
                switchTab('myOrders');
            }, 2000);
        }

        function filterMyOrders(status) {
            console.log('Filtering orders by status:', status);
            currentOrderFilter = status;
            
            // Update active tab
            document.querySelectorAll('.order-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.order-filter-tab[data-status="${status}"]`).classList.add('active');
            
            // Reload orders with filter
            loadMyOrders();
        }

        function loadMyOrders() {
            if (!currentUser) return;

            // Reload orders from storage to ensure we have latest data
            const storedOrders = localStorage.getItem('blindOrders');
            if (storedOrders) {
                orders = JSON.parse(storedOrders);
            }

            // Only show orders from the current user
            const myOrders = orders.filter(o => o.userId === currentUser.id);
            
            // Count orders by status
            const counts = {
                all: myOrders.length,
                pending: myOrders.filter(o => o.status === 'pending').length,
                confirmed: myOrders.filter(o => o.status === 'confirmed').length,
                production: myOrders.filter(o => o.status === 'production').length,
                completed: myOrders.filter(o => o.status === 'completed').length
            };
            
            // Update counts in tabs
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countPending').textContent = counts.pending;
            document.getElementById('countConfirmed').textContent = counts.confirmed;
            document.getElementById('countProduction').textContent = counts.production;
            document.getElementById('countCompleted').textContent = counts.completed;
            
            // Filter orders based on current filter
            let filteredOrders = myOrders;
            if (currentOrderFilter !== 'all') {
                filteredOrders = myOrders.filter(o => o.status === currentOrderFilter);
            }

            const container = document.getElementById('myOrdersList');

            if (filteredOrders.length === 0) {
                const statusText = currentOrderFilter === 'all' ? 'orders' : `${currentOrderFilter} orders`;
                container.innerHTML = `<p style="text-align: center; color: #666; padding: 40px;">No ${statusText} yet.</p>`;
                return;
            }

            container.innerHTML = filteredOrders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <h3>Order #${order.id}</h3>
                            <p style="color: #666; margin-top: 5px;">${order.productType ? order.productType.charAt(0).toUpperCase() + order.productType.slice(1) : 'Blinds'} Order</p>
                            <p style="color: #666;">Placed: ${new Date(order.createdAt).toLocaleDateString()}</p>
                        </div>
                        <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
                    </div>
                    <div class="item-grid">
                        <div class="item-detail">
                            <strong>Order Date:</strong>
                            <span>${order.orderDate}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Required By:</strong>
                            <span>${order.dateRequired || 'Not specified'}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Total Items:</strong>
                            <span>${order.items.length}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Total:</strong>
                            <span style="font-size: 1.3em; color: #667eea;">${order.total}</span>
                        </div>
                    </div>
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #667eea;">View Details</summary>
                        <div style="margin-top: 15px;">
                            ${order.items.map((item, idx) => {
                                if (item.type === 'curtain') {
                                    return `
                                        <div class="order-item">
                                            <h4>Curtain ${idx + 1} - ${item.location || 'No location'}</h4>
                                            <div class="item-grid">
                                                <div class="item-detail"><strong>Width:</strong><span>${item.width}mm</span></div>
                                                <div class="item-detail"><strong>Drop:</strong><span>${item.drop}mm</span></div>
                                                ${item.dropDeducted ? `<div class="item-detail"><strong>After Deductions:</strong><span>${item.dropDeducted}mm</span></div>` : ''}
                                                <div class="item-detail"><strong>Type:</strong><span>${item.curtainType}</span></div>
                                                <div class="item-detail"><strong>Fabric:</strong><span>${item.fabric}</span></div>
                                                <div class="item-detail"><strong>Colour:</strong><span>${item.colour}</span></div>
                                                ${item.lining ? `<div class="item-detail"><strong>Lining:</strong><span>${item.lining}</span></div>` : ''}
                                                <div class="item-detail"><strong>Price:</strong><span>${item.price}</span></div>
                                            </div>
                                        </div>
                                    `;
                                } else if (item.type === 'shutter') {
                                    return `
                                        <div class="order-item">
                                            <h4>Shutter ${idx + 1} - ${item.room || 'No room'}</h4>
                                            <div class="item-grid">
                                                <div class="item-detail"><strong>Width:</strong><span>${item.width}mm</span></div>
                                                <div class="item-detail"><strong>Drop:</strong><span>${item.drop}mm</span></div>
                                                <div class="item-detail"><strong>Mid Rail:</strong><span>${item.midRail}</span></div>
                                                <div class="item-detail"><strong>Panels:</strong><span>${item.panels}</span></div>
                                                <div class="item-detail"><strong>Layout:</strong><span>${item.layoutCode}</span></div>
                                                <div class="item-detail"><strong>Frame:</strong><span>${item.frameCode} ${item.frameStyle}</span></div>
                                                <div class="item-detail"><strong>Frame Request:</strong><span>${item.frameRequest}</span></div>
                                                <div class="item-detail"><strong>Material:</strong><span>${item.material}</span></div>
                                                <div class="item-detail"><strong>Color:</strong><span>${item.colorCode}</span></div>
                                                <div class="item-detail"><strong>Louver Size:</strong><span>${item.louverSize}</span></div>
                                                <div class="item-detail"><strong>Price:</strong><span>${item.price}</span></div>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="order-item">
                                            <h4>Blind ${idx + 1} - ${item.location || 'No location'}</h4>
                                            <div class="item-grid">
                                                <div class="item-detail"><strong>Width:</strong><span>${item.width}mm</span></div>
                                                <div class="item-detail"><strong>Drop:</strong><span>${item.drop}mm</span></div>
                                                ${item.group ? `<div class="item-detail"><strong>Group:</strong><span>Group ${item.group}</span></div>` : ''}
                                                ${item.material ? `<div class="item-detail"><strong>Material:</strong><span>${item.material}</span></div>` : ''}
                                                ${item.fabricType ? `<div class="item-detail"><strong>Fabric Type:</strong><span>${item.fabricType}</span></div>` : ''}
                                                ${item.fabricColour ? `<div class="item-detail"><strong>Fabric Colour:</strong><span>${item.fabricColour}</span></div>` : ''}
                                                ${item.controlSide ? `<div class="item-detail"><strong>Control Side:</strong><span>${item.controlSide}</span></div>` : ''}
                                                ${item.chainMotor ? `<div class="item-detail"><strong>Chain/Motor:</strong><span>${item.chainMotor}</span></div>` : ''}
                                                ${item.bracketType ? `<div class="item-detail"><strong>Bracket Type:</strong><span>${item.bracketType}</span></div>` : ''}
                                                ${item.bracketColour ? `<div class="item-detail"><strong>Bracket Colour:</strong><span>${item.bracketColour}</span></div>` : ''}
                                                ${item.discount && item.discount !== '0' ? `<div class="item-detail"><strong>Discount:</strong><span>${item.discount}%</span></div>` : ''}
                                                <div class="item-detail"><strong>Price:</strong><span>${item.price}</span></div>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                            ${order.notes ? `<p style="margin-top: 15px;"><strong>Notes:</strong> ${order.notes}</p>` : ''}
                            <button class="btn btn-info" style="margin-top: 15px;" onclick="exportOrderToCSV(${order.id})">ðŸ“¥ Export to CSV</button>
                        </div>
                    </details>
                </div>
            `).reverse().join('');
        }

        function loadTestDataManually() {
            // Remove the flag so it can reload
            localStorage.removeItem('testDataInitialized');
            
            // Run initialization
            initializeTestData();
            
            // Reload all views
            loadCustomerManagement();
            loadAllOrders();
            
            alert('Test data loaded! 3 customers and 4 orders added.');
        }

        function clearAllData() {
            if (!confirm('This will delete ALL data (users, orders, pricing). Are you sure?')) {
                return;
            }
            
            localStorage.clear();
            alert('All data cleared! Page will reload.');
            location.reload();
        }

        function updateQuoteProductType() {
            const productType = document.getElementById('quoteProductType').value;
            document.getElementById('quoteItemTypeLabel').textContent = productType === 'blinds' ? 'Blind' : 'Curtain';
            document.getElementById('addQuoteItemLabel').textContent = productType === 'blinds' ? 'Blind' : 'Curtain';
            
            // Clear existing items when switching
            document.getElementById('quoteItems').innerHTML = '';
            quoteItemCounter = 0;
            updateQuoteTotals();
        }

        function addQuoteItem() {
            const productType = document.getElementById('quoteProductType').value;
            if (productType === 'blinds') {
                addQuoteBlindItem();
            } else {
                addQuoteCurtainItem();
            }
        }

        function addQuoteBlindItem() {
            quoteItemCounter++;
            const container = document.getElementById('quoteItems');
            
            const blindRow = document.createElement('div');
            blindRow.className = 'blind-row';
            blindRow.id = `quote-${quoteItemCounter}`;
            blindRow.dataset.type = 'blind';
            
            blindRow.innerHTML = `
                <div class="blind-row-header">
                    <h4>Blind #${quoteItemCounter}</h4>
                    <button class="btn btn-danger" onclick="removeQuoteItem(${quoteItemCounter})">Remove</button>
                </div>
                <div class="blind-fields">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" class="quote-location" placeholder="e.g., Living Room">
                    </div>
                    <div class="form-group">
                        <label>Width (mm)</label>
                        <input type="number" class="quote-width" onchange="calculateQuotePrice(${quoteItemCounter})">
                    </div>
                    <div class="form-group">
                        <label>Drop (mm)</label>
                        <input type="number" class="quote-drop" onchange="calculateQuotePrice(${quoteItemCounter})">
                    </div>
                    <div class="form-group">
                        <label>Fabric Group</label>
                        <select class="quote-group" onchange="calculateQuotePrice(${quoteItemCounter})">
                            <option value="">Select...</option>
                            <option value="1">Group 1</option>
                            <option value="2">Group 2</option>
                            <option value="3">Group 3</option>
                            <option value="4">Group 4</option>
                            <option value="5">Group 5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Price</label>
                        <input type="text" class="quote-price" readonly style="background: #e9ecef; font-weight: bold; color: #667eea; font-size: 1.1em;">
                    </div>
                </div>
            `;
            
            container.appendChild(blindRow);
            updateQuoteTotals();
        }

        function addQuoteCurtainItem() {
            quoteItemCounter++;
            const container = document.getElementById('quoteItems');
            
            const curtainRow = document.createElement('div');
            curtainRow.className = 'blind-row';
            curtainRow.id = `quote-${quoteItemCounter}`;
            curtainRow.dataset.type = 'curtain';
            
            curtainRow.innerHTML = `
                <div class="blind-row-header">
                    <h4>Curtain #${quoteItemCounter}</h4>
                    <button class="btn btn-danger" onclick="removeQuoteItem(${quoteItemCounter})">Remove</button>
                </div>
                <div class="blind-fields">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" class="quote-location" placeholder="e.g., Bedroom">
                    </div>
                    <div class="form-group">
                        <label>Width (mm)</label>
                        <input type="number" class="quote-width" onchange="updateQuoteTotals()">
                    </div>
                    <div class="form-group">
                        <label>Drop (mm)</label>
                        <input type="number" class="quote-drop" onchange="updateQuoteTotals()">
                    </div>
                    <div class="form-group">
                        <label>Curtain Type</label>
                        <select class="quote-curtain-type">
                            <option value="">Select...</option>
                            <option value="S Fold">S Fold</option>
                            <option value="Pencil Pleat">Pencil Pleat</option>
                            <option value="Eyelet">Eyelet</option>
                            <option value="Wave">Wave</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Price</label>
                        <input type="text" class="quote-price" placeholder="$0.00" onchange="updateQuoteTotals()">
                    </div>
                </div>
            `;
            
            container.appendChild(curtainRow);
            updateQuoteTotals();
        }

        function removeQuoteItem(id) {
            document.getElementById(`quote-${id}`).remove();
            updateQuoteTotals();
        }

        function calculateQuotePrice(id) {
            const row = document.getElementById(`quote-${id}`);
            const width = parseInt(row.querySelector('.quote-width').value);
            const drop = parseInt(row.querySelector('.quote-drop').value);
            const group = parseInt(row.querySelector('.quote-group').value);

            if (width && drop && group) {
                let price = getPrice(width, drop, group);
                if (price) {
                    row.querySelector('.quote-price').value = `$${price.toFixed(2)}`;
                } else {
                    row.querySelector('.quote-price').value = 'N/A';
                }
            } else {
                row.querySelector('.quote-price').value = '';
            }

            updateQuoteTotals();
        }

        function updateQuoteTotals() {
            const quoteRows = document.querySelectorAll('#quoteItems .blind-row');
            let count = 0;
            let total = 0;

            quoteRows.forEach(row => {
                const priceInput = row.querySelector('.quote-price');
                const priceText = priceInput.value;
                
                if (priceText && priceText !== 'N/A') {
                    count++;
                    const priceValue = parseFloat(priceText.replace('$', '').replace(',', ''));
                    if (!isNaN(priceValue)) {
                        total += priceValue;
                    }
                }
            });

            document.getElementById('quoteTotalItems').textContent = count;
            document.getElementById('quoteSubtotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('quoteGrandTotal').textContent = `$${total.toFixed(2)}`;
        }

        function saveQuote() {
            if (!currentUser) {
                showAlert('quoteAlert', 'Please login to save quotes', 'error');
                return;
            }

            const productType = document.getElementById('quoteProductType').value;
            const quoteRows = document.querySelectorAll('#quoteItems .blind-row');
            const items = [];

            quoteRows.forEach(row => {
                const width = row.querySelector('.quote-width').value;
                const drop = row.querySelector('.quote-drop').value;
                
                if (width && drop) {
                    if (row.dataset.type === 'curtain') {
                        items.push({
                            type: 'curtain',
                            location: row.querySelector('.quote-location').value,
                            width: width,
                            drop: drop,
                            curtainType: row.querySelector('.quote-curtain-type').value,
                            price: row.querySelector('.quote-price').value
                        });
                    } else {
                        items.push({
                            type: 'blind',
                            location: row.querySelector('.quote-location').value,
                            width: width,
                            drop: drop,
                            group: row.querySelector('.quote-group').value,
                            price: row.querySelector('.quote-price').value
                        });
                    }
                }
            });

            if (items.length === 0) {
                showAlert('quoteAlert', 'Please add at least one item to save quote', 'error');
                return;
            }

            const quote = {
                id: Date.now(),
                userId: currentUser.id,
                customerName: currentUser.name,
                productType: productType,
                items: items,
                notes: document.getElementById('quoteNotes').value,
                total: document.getElementById('quoteGrandTotal').textContent,
                createdAt: new Date().toISOString()
            };

            // Load existing quotes
            const savedQuotes = JSON.parse(localStorage.getItem('customerQuotes') || '[]');
            savedQuotes.push(quote);
            localStorage.setItem('customerQuotes', JSON.stringify(savedQuotes));

            showAlert('quoteAlert', 'Quote saved successfully! You can view it in "My Saved Quotes" below.', 'success');
            
            // Clear quote form
            document.getElementById('quoteItems').innerHTML = '';
            document.getElementById('quoteNotes').value = '';
            quoteItemCounter = 0;
            updateQuoteTotals();
            
            // Reload saved quotes
            loadSavedQuotes();
        }

        function convertQuoteToOrder() {
            console.log('convertQuoteToOrder called');
            
            if (!currentUser) {
                showAlert('quoteAlert', 'Please login to place orders', 'error');
                return;
            }

            const quoteRows = document.querySelectorAll('#quoteItems .blind-row');
            console.log('Quote rows found:', quoteRows.length);
            
            if (quoteRows.length === 0) {
                showAlert('quoteAlert', 'Please add at least one item to convert to order', 'error');
                return;
            }

            if (!confirm('Convert this quote to an order? You will be taken to the order form to complete the details.')) {
                return;
            }

            try {
                // Get quote data
                const productType = document.getElementById('quoteProductType').value;
                const quoteNotes = document.getElementById('quoteNotes').value;

                console.log('Product type:', productType);

                // Switch to new order tab
                switchTab('newOrder');

                // Small delay to ensure tab is loaded
                setTimeout(() => {
                    try {
                        // Set product type
                        document.getElementById('productType').value = productType;
                        updateProductType();

                        // Clear any existing items in order form
                        document.getElementById('blindItems').innerHTML = '';
                        blindItemCounter = 0;

                        // Add each quote item to the order form
                        quoteRows.forEach((row, index) => {
                            console.log('Processing row', index);
                            const width = row.querySelector('.quote-width').value;
                            const drop = row.querySelector('.quote-drop').value;
                            const location = row.querySelector('.quote-location').value;
                            
                            if (width && drop) {
                                if (row.dataset.type === 'curtain') {
                                    addCurtainItem();
                                    const newRow = document.getElementById(`blind-${blindItemCounter}`);
                                    if (newRow) {
                                        newRow.querySelector('.curtain-location').value = location;
                                        newRow.querySelector('.curtain-width').value = width;
                                        newRow.querySelector('.curtain-drop').value = drop;
                                        const curtainType = row.querySelector('.quote-curtain-type').value;
                                        if (curtainType) {
                                            newRow.querySelector('.curtain-type').value = curtainType;
                                        }
                                        const price = row.querySelector('.quote-price').value;
                                        if (price) {
                                            newRow.querySelector('.curtain-price').value = price;
                                        }
                                    }
                                } else {
                                    addBlindItem();
                                    const newRow = document.getElementById(`blind-${blindItemCounter}`);
                                    if (newRow) {
                                        newRow.querySelector('.blind-location').value = location;
                                        newRow.querySelector('.blind-width').value = width;
                                        newRow.querySelector('.blind-drop').value = drop;
                                        const group = row.querySelector('.quote-group').value;
                                        if (group) {
                                            newRow.querySelector('.blind-group').value = group;
                                            calculatePrice(blindItemCounter);
                                        }
                                    }
                                }
                            }
                        });

                        // Add quote notes to order notes
                        if (quoteNotes) {
                            document.getElementById('additionalNotes').value = quoteNotes + '\n\n(Converted from quote)';
                        } else {
                            document.getElementById('additionalNotes').value = '(Converted from quote)';
                        }

                        // Update totals
                        updateTotals();

                        // Show success message
                        showAlert('orderAlert', 'Quote items loaded! Please complete the remaining details and submit your order.', 'success');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        
                    } catch (error) {
                        console.error('Error in conversion:', error);
                        alert('Error converting quote: ' + error.message);
                    }
                }, 300);
                
            } catch (error) {
                console.error('Error in convertQuoteToOrder:', error);
                alert('Error: ' + error.message);
            }
        }

        function loadSavedQuotes() {
            console.log('=== loadSavedQuotes START ===');
            
            if (!currentUser) {
                console.log('ERROR: No current user');
                return;
            }
            console.log('Current user:', currentUser.name, currentUser.id);

            const container = document.getElementById('savedQuotesList');
            if (!container) {
                console.error('ERROR: savedQuotesList container not found!');
                return;
            }
            console.log('Container found:', container);
            
            const savedQuotes = JSON.parse(localStorage.getItem('customerQuotes') || '[]');
            console.log('Total saved quotes in storage:', savedQuotes.length);
            console.log('All quotes:', savedQuotes);
            
            const myQuotes = savedQuotes.filter(q => q.userId === currentUser.id);
            console.log('Filtered quotes for user', currentUser.id, ':', myQuotes.length);
            console.log('My quotes:', myQuotes);

            if (myQuotes.length === 0) {
                console.log('No quotes - showing empty message');
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; background: #f8f9fa; border-radius: 8px;">No saved quotes yet.</p>';
                console.log('Container updated with empty message');
                return;
            }

            console.log('Building HTML for', myQuotes.length, 'quotes');
            const html = myQuotes.sort((a, b) => b.id - a.id).map(quote => `
                <div class="quote-card">
                    <div class="quote-header">
                        <div>
                            <h3>Quote #${quote.id}</h3>
                            <p style="color: #666; margin-top: 5px;">${quote.productType ? quote.productType.charAt(0).toUpperCase() + quote.productType.slice(1) : 'Blinds'} Quote</p>
                            <p style="color: #666;">Created: ${new Date(quote.createdAt).toLocaleDateString()}</p>
                        </div>
                        <span class="quote-badge">QUOTE</span>
                    </div>
                    <div class="item-grid">
                        <div class="item-detail">
                            <strong>Items:</strong>
                            <span>${quote.items.length}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Estimated Total:</strong>
                            <span style="font-size: 1.3em; color: #667eea;">${quote.total}</span>
                        </div>
                    </div>
                    ${quote.notes ? `<p style="margin-top: 15px;"><strong>Notes:</strong> ${quote.notes}</p>` : ''}
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="window.convertSavedQuoteToOrder(${quote.id})">âœ“ Convert to Order</button>
                        <button class="btn btn-danger" onclick="window.deleteQuote(${quote.id})">Delete Quote</button>
                    </div>
                </div>
            `).join('');
            
            console.log('HTML built, length:', html.length);
            container.innerHTML = html;
            console.log('Container innerHTML updated');
            console.log('=== loadSavedQuotes END ===');
        }

        // Make functions globally accessible
        window.deleteQuote = deleteQuote;
        window.convertSavedQuoteToOrder = convertSavedQuoteToOrder;
        window.convertQuoteToOrder = convertQuoteToOrder;
        window.filterMyOrders = filterMyOrders;
        window.filterAllOrdersByProduct = filterAllOrdersByProduct;

        function convertSavedQuoteToOrder(quoteId) {
            const savedQuotes = JSON.parse(localStorage.getItem('customerQuotes') || '[]');
            const quote = savedQuotes.find(q => q.id === quoteId);
            
            if (!quote) {
                alert('Quote not found');
                return;
            }

            if (!confirm('Convert this saved quote to an order? You will be taken to the order form to complete the details.')) {
                return;
            }

            // Switch to new order tab
            switchTab('newOrder');

            // Set product type
            document.getElementById('productType').value = quote.productType;
            updateProductType();

            // Clear any existing items in order form
            document.getElementById('blindItems').innerHTML = '';
            blindItemCounter = 0;

            // Add each quote item to the order form
            quote.items.forEach(item => {
                if (item.type === 'curtain') {
                    addCurtainItem();
                    const newRow = document.getElementById(`blind-${blindItemCounter}`);
                    if (newRow) {
                        newRow.querySelector('.curtain-location').value = item.location || '';
                        newRow.querySelector('.curtain-width').value = item.width || '';
                        newRow.querySelector('.curtain-drop').value = item.drop || '';
                        if (item.curtainType) {
                            newRow.querySelector('.curtain-type').value = item.curtainType;
                        }
                        if (item.price) {
                            newRow.querySelector('.curtain-price').value = item.price;
                        }
                        // Pre-fill any other saved details if available
                        if (item.dropDeducted) newRow.querySelector('.curtain-drop-deducted').value = item.dropDeducted;
                        if (item.hem) newRow.querySelector('.curtain-hem').value = item.hem;
                        if (item.fabric) newRow.querySelector('.curtain-fabric').value = item.fabric;
                        if (item.colour) newRow.querySelector('.curtain-colour').value = item.colour;
                        if (item.lining) newRow.querySelector('.curtain-lining').value = item.lining;
                        if (item.installation) newRow.querySelector('.curtain-installation').value = item.installation;
                        if (item.bracketType) newRow.querySelector('.curtain-bracket').value = item.bracketType;
                        if (item.trackType) newRow.querySelector('.curtain-track-type').value = item.trackType;
                        if (item.trackColour) newRow.querySelector('.curtain-track-colour').value = item.trackColour;
                        if (item.openingType) newRow.querySelector('.curtain-opening').value = item.openingType;
                        if (item.wandSize) newRow.querySelector('.curtain-wand').value = item.wandSize;
                        if (item.itemNotes) newRow.querySelector('.curtain-notes').value = item.itemNotes;
                    }
                } else {
                    addBlindItem();
                    const newRow = document.getElementById(`blind-${blindItemCounter}`);
                    if (newRow) {
                        newRow.querySelector('.blind-location').value = item.location || '';
                        newRow.querySelector('.blind-width').value = item.width || '';
                        newRow.querySelector('.blind-drop').value = item.drop || '';
                        if (item.group) {
                            newRow.querySelector('.blind-group').value = item.group;
                            calculatePrice(blindItemCounter);
                        }
                        // Pre-fill any other saved details if available
                        if (item.fixing) newRow.querySelector('.blind-fixing').value = item.fixing;
                        if (item.controlSide) newRow.querySelector('.blind-control-side').value = item.controlSide;
                        if (item.controlType) {
                            newRow.querySelector('.blind-control-type').value = item.controlType;
                            toggleMotorOptions(blindItemCounter);
                        }
                        if (item.motorType) newRow.querySelector('.blind-motor-type').value = item.motorType;
                        if (item.controlColour) newRow.querySelector('.blind-control-colour').value = item.controlColour;
                        if (item.chain) newRow.querySelector('.blind-chain').value = item.chain;
                        if (item.roll) newRow.querySelector('.blind-roll').value = item.roll;
                        if (item.fabric) newRow.querySelector('.blind-fabric').value = item.fabric;
                        if (item.colour) newRow.querySelector('.blind-colour').value = item.colour;
                        if (item.railType) newRow.querySelector('.blind-rail-type').value = item.railType;
                        if (item.railColour) newRow.querySelector('.blind-rail-colour').value = item.railColour;
                        if (item.discount) newRow.querySelector('.blind-discount').value = item.discount;
                    }
                }
            });

            // Add quote notes to order notes
            if (quote.notes) {
                document.getElementById('additionalNotes').value = quote.notes + '\n\n(Converted from saved quote)';
            } else {
                document.getElementById('additionalNotes').value = '(Converted from saved quote)';
            }

            // Update totals
            updateTotals();

            // Show success message
            setTimeout(() => {
                showAlert('orderAlert', 'Quote items loaded! Please complete the remaining details and submit your order.', 'success');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 500);
        }

        function deleteQuote(quoteId) {
            console.log('deleteQuote called with ID:', quoteId);
            
            if (!confirm('Are you sure you want to delete this quote?')) {
                return;
            }

            try {
                // Delete from localStorage
                let savedQuotes = JSON.parse(localStorage.getItem('customerQuotes') || '[]');
                console.log('Quotes before delete:', savedQuotes.length);
                
                const initialLength = savedQuotes.length;
                savedQuotes = savedQuotes.filter(q => q.id !== quoteId);
                
                console.log('Quotes after delete:', savedQuotes.length);
                
                if (initialLength === savedQuotes.length) {
                    alert('Error: Quote not found');
                    return;
                }
                
                localStorage.setItem('customerQuotes', JSON.stringify(savedQuotes));
                console.log('Quote deleted from storage');

                // Force reload the saved quotes section
                loadSavedQuotes();
                
                // Show visible alert at the top
                alert('Quote deleted successfully!');
                
                console.log('Delete complete');
                
            } catch (error) {
                console.error('Error deleting quote:', error);
                alert('Error deleting quote: ' + error.message);
            }
        }

        function createNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const company = document.getElementById('newUserCompany').value.trim();
            const address = document.getElementById('newUserAddress').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const passwordConfirm = document.getElementById('newUserPasswordConfirm').value;

            // Validation
            if (!name || !email || !phone || !address || !password) {
                showAlert('userCreateAlert', 'Please fill in all required fields (*)', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showAlert('userCreateAlert', 'Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('userCreateAlert', 'Password must be at least 6 characters', 'error');
                return;
            }

            // Check if email already exists
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.find(u => u.email === email)) {
                showAlert('userCreateAlert', 'Email already exists', 'error');
                return;
            }

            // Create new user
            const newUser = {
                id: Date.now(),
                name: name,
                company: company,
                email: email,
                phone: phone,
                address: address,
                password: password,
                role: 'customer',
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            showAlert('userCreateAlert', `Customer account created successfully! Login: ${email} / ${password}`, 'success');
            
            // Clear form
            clearUserForm();
            
            // Reload users list
            loadUserManagement();
        }

        function clearUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPhone').value = '';
            document.getElementById('newUserCompany').value = '';
            document.getElementById('newUserAddress').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserPasswordConfirm').value = '';
        }

        function loadUserManagement() {
            if (!currentUser || currentUser.role !== 'admin') return;

            const container = document.getElementById('usersList');
            const users = JSON.parse(localStorage.getItem('users') || '[]');

            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No customer accounts yet. Create one above!</p>';
                return;
            }

            // Reload orders from storage
            const storedOrders = localStorage.getItem('blindOrders');
            if (storedOrders) {
                orders = JSON.parse(storedOrders);
            }

            const userRows = users.map(user => {
                const userOrders = orders.filter(o => o.userId === user.id);
                const totalSpent = userOrders.reduce((sum, order) => {
                    const amount = parseFloat(order.total.replace('$', '').replace(',', ''));
                    return sum + (isNaN(amount) ? 0 : amount);
                }, 0);

                return `
                    <div class="user-row">
                        <div class="user-info-block">
                            <div class="user-info-label">Name</div>
                            <div class="user-info-value">${user.name}</div>
                            ${user.company ? `<div style="font-size: 0.9em; color: #666; margin-top: 3px;">${user.company}</div>` : ''}
                        </div>
                        <div class="user-info-block">
                            <div class="user-info-label">Contact</div>
                            <div class="user-info-value">${user.email}</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 3px;">${user.phone}</div>
                        </div>
                        <div class="user-info-block">
                            <div class="user-info-label">Login Credentials</div>
                            <div class="user-info-value" style="font-size: 0.9em;">
                                <strong>Email:</strong> ${user.email}<br>
                                <strong>Password:</strong> ${user.password}
                            </div>
                        </div>
                        <div class="user-info-block">
                            <div class="user-info-label">Orders</div>
                            <div class="user-info-value">${userOrders.length} orders</div>
                            <div style="font-size: 0.9em; color: #667eea; margin-top: 3px;">$${totalSpent.toFixed(2)}</div>
                        </div>
                        <div>
                            <button class="btn btn-danger" style="font-size: 0.85em; padding: 8px 15px;" onclick="deleteUser(${user.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = userRows;
        }

        function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this customer account? This will also delete all their orders.')) {
                return;
            }

            // Remove user
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            users = users.filter(u => u.id !== userId);
            localStorage.setItem('users', JSON.stringify(users));

            // Remove user's orders
            orders = orders.filter(o => o.userId !== userId);
            localStorage.setItem('blindOrders', JSON.stringify(orders));

            // Reload
            loadUserManagement();
            loadCustomerManagement();
            loadAllOrders();

            alert('Customer account and all associated orders have been deleted.');
        }

        function loadCustomerManagement() {
            if (!currentUser || currentUser.role !== 'admin') return;

            const container = document.getElementById('customerList');
            
            // Reload orders from storage to ensure we have latest data
            const storedOrders = localStorage.getItem('blindOrders');
            if (storedOrders) {
                orders = JSON.parse(storedOrders);
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');

            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No customers registered yet.</p>';
                return;
            }

            // Build customer cards
            const customerCards = users.map(user => {
                const userOrders = orders.filter(o => o.userId === user.id);
                const totalSpent = userOrders.reduce((sum, order) => {
                    const amount = parseFloat(order.total.replace('$', '').replace(',', ''));
                    return sum + (isNaN(amount) ? 0 : amount);
                }, 0);

                const blindOrders = userOrders.filter(o => o.productType === 'blinds' || !o.productType);
                const curtainOrders = userOrders.filter(o => o.productType === 'curtains');

                return `
                    <div class="customer-card">
                        <div class="customer-header">
                            <div>
                                <h3 style="color: #333; margin-bottom: 5px;">${user.name}</h3>
                                <p style="color: #666; margin: 0;">${user.email}</p>
                                ${user.company ? `<p style="color: #666; margin: 5px 0 0 0;"><strong>Company:</strong> ${user.company}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <p style="color: #666; margin: 0;"><strong>Phone:</strong> ${user.phone}</p>
                                <p style="color: #666; margin: 5px 0 0 0;"><strong>ID:</strong> ${user.id}</p>
                            </div>
                        </div>

                        <div class="customer-info">
                            <div class="customer-stat">
                                <div class="customer-stat-value">${userOrders.length}</div>
                                <div class="customer-stat-label">Total Orders</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value">${blindOrders.length}</div>
                                <div class="customer-stat-label">Blind Orders</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value">${curtainOrders.length}</div>
                                <div class="customer-stat-label">Curtain Orders</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value">$${totalSpent.toFixed(2)}</div>
                                <div class="customer-stat-label">Total Spent</div>
                            </div>
                        </div>

                        ${user.address ? `<p style="color: #666; margin-bottom: 15px;"><strong>Address:</strong> ${user.address}</p>` : ''}

                        ${userOrders.length > 0 ? `
                            <details style="margin-top: 20px;">
                                <summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    View Order History (${userOrders.length} orders)
                                </summary>
                                <div style="margin-top: 15px;">
                                    <!-- Order Status Summary -->
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                                        <div style="background: #fff3cd; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 1.5em; font-weight: bold; color: #856404;">${userOrders.filter(o => o.status === 'pending').length}</div>
                                            <div style="font-size: 0.85em; color: #856404;">Pending</div>
                                        </div>
                                        <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 1.5em; font-weight: bold; color: #0c5460;">${userOrders.filter(o => o.status === 'confirmed').length}</div>
                                            <div style="font-size: 0.85em; color: #0c5460;">Confirmed</div>
                                        </div>
                                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 1.5em; font-weight: bold; color: #1976d2;">${userOrders.filter(o => o.status === 'production').length}</div>
                                            <div style="font-size: 0.85em; color: #1976d2;">Production</div>
                                        </div>
                                        <div style="background: #d4edda; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 1.5em; font-weight: bold; color: #155724;">${userOrders.filter(o => o.status === 'completed').length}</div>
                                            <div style="font-size: 0.85em; color: #155724;">Completed</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Order List -->
                                    ${userOrders.sort((a, b) => b.id - a.id).map(order => `
                                        <div class="order-item" style="margin-bottom: 20px; border-left: 4px solid ${
                                            order.status === 'pending' ? '#ffc107' :
                                            order.status === 'confirmed' ? '#17a2b8' :
                                            order.status === 'production' ? '#1976d2' :
                                            '#28a745'
                                        };">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <div>
                                                    <h4 style="margin: 0;">Order #${order.id}</h4>
                                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">
                                                        ${order.productType ? order.productType.charAt(0).toUpperCase() + order.productType.slice(1) : 'Blinds'} Order
                                                    </p>
                                                </div>
                                                <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
                                            </div>
                                            <div class="item-grid">
                                                <div class="item-detail">
                                                    <strong>Order Date:</strong>
                                                    <span>${order.orderDate || 'N/A'}</span>
                                                </div>
                                                <div class="item-detail">
                                                    <strong>Date Required:</strong>
                                                    <span>${order.dateRequired || 'Not specified'}</span>
                                                </div>
                                                <div class="item-detail">
                                                    <strong>Placed:</strong>
                                                    <span>${new Date(order.createdAt).toLocaleDateString()}</span>
                                                </div>
                                                <div class="item-detail">
                                                    <strong>Items:</strong>
                                                    <span>${order.items.length}</span>
                                                </div>
                                                <div class="item-detail">
                                                    <strong>Total:</strong>
                                                    <span style="color: #667eea; font-weight: bold; font-size: 1.2em;">${order.total}</span>
                                                </div>
                                            </div>
                                            
                                            ${order.notes ? `<p style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.9em;"><strong>Notes:</strong> ${order.notes}</p>` : ''}
                                            
                                            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                                <button class="btn btn-info" style="font-size: 0.9em; padding: 8px 15px;" onclick="exportOrderToCSV(${order.id})">ðŸ“¥ Export CSV</button>
                                                ${order.status === 'pending' ? `<button class="btn btn-success" style="font-size: 0.9em; padding: 8px 15px;" onclick="confirmOrder(${order.id})">âœ“ Confirm & Start</button>` : ''}
                                                ${order.status === 'confirmed' ? `<button class="btn btn-primary" style="font-size: 0.9em; padding: 8px 15px;" onclick="changeOrderStatus(${order.id}, 'production')">ðŸ­ To Production</button>` : ''}
                                                ${order.status === 'production' ? `<button class="btn btn-success" style="font-size: 0.9em; padding: 8px 15px;" onclick="changeOrderStatus(${order.id}, 'completed')">âœ“ Complete</button>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        ` : '<p style="color: #999; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 6px; margin-top: 10px;">No orders yet</p>'}
                    </div>
                `;
            }).join('');

            container.innerHTML = customerCards;
        }

        function filterAllOrdersByProduct(productType) {
            console.log('Filtering orders by product:', productType);
            currentProductFilter = productType;
            
            // Update active tab
            document.querySelectorAll('.order-filter-tab[data-product]').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`.order-filter-tab[data-product="${productType}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Reload orders with filter
            loadAllOrders();
        }

        function loadAllOrders() {
            if (!currentUser || currentUser.role !== 'admin') return;

            const container = document.getElementById('allOrdersList');

            // Reload orders from storage to ensure we have latest data
            const storedOrders = localStorage.getItem('blindOrders');
            if (storedOrders) {
                orders = JSON.parse(storedOrders);
            }

            // Count orders by product type
            const productCounts = {
                all: orders.length,
                blinds: orders.filter(o => !o.productType || o.productType === 'blinds').length,
                curtains: orders.filter(o => o.productType === 'curtains').length,
                shutters: orders.filter(o => o.productType === 'shutters').length
            };
            
            // Update counts in tabs
            const countAllEl = document.getElementById('productCountAll');
            const countBlindsEl = document.getElementById('productCountBlinds');
            const countCurtainsEl = document.getElementById('productCountCurtains');
            const countShuttersEl = document.getElementById('productCountShutters');
            
            if (countAllEl) countAllEl.textContent = productCounts.all;
            if (countBlindsEl) countBlindsEl.textContent = productCounts.blinds;
            if (countCurtainsEl) countCurtainsEl.textContent = productCounts.curtains;
            if (countShuttersEl) countShuttersEl.textContent = productCounts.shutters;

            // Filter orders based on current product filter
            let filteredOrders = orders;
            if (currentProductFilter === 'blinds') {
                filteredOrders = orders.filter(o => !o.productType || o.productType === 'blinds');
            } else if (currentProductFilter === 'curtains') {
                filteredOrders = orders.filter(o => o.productType === 'curtains');
            } else if (currentProductFilter === 'shutters') {
                filteredOrders = orders.filter(o => o.productType === 'shutters');
            }

            if (filteredOrders.length === 0) {
                const productText = currentProductFilter === 'all' ? 'orders' : `${currentProductFilter} orders`;
                container.innerHTML = `<p style="text-align: center; color: #666; padding: 40px;">No ${productText} in system.</p>`;
                return;
            }

            container.innerHTML = filteredOrders.map(order => {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.id === order.userId);
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <h3>Order #${order.id}</h3>
                            <p style="color: #666; margin-top: 5px;">${order.productType ? order.productType.charAt(0).toUpperCase() + order.productType.slice(1) : 'Blinds'} Order</p>
                            <p style="color: #666;">Customer: ${order.customerName}</p>
                            <p style="color: #666;">Placed: ${new Date(order.createdAt).toLocaleDateString()}</p>
                        </div>
                        <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
                    </div>
                    <div class="item-grid">
                        <div class="item-detail">
                            <strong>Company:</strong>
                            <span>${order.companyName || 'N/A'}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Contact:</strong>
                            <span>${user ? user.phone : 'N/A'}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Total Items:</strong>
                            <span>${order.items.length}</span>
                        </div>
                        <div class="item-detail">
                            <strong>Total:</strong>
                            <span style="font-size: 1.3em; color: #667eea;">${order.total}</span>
                        </div>
                    </div>
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #667eea;">View Full Order Details</summary>
                        <div style="margin-top: 15px;">
                            ${order.items.map((item, idx) => {
                                if (item.type === 'curtain') {
                                    return `
                                        <div class="order-item">
                                            <h4>Curtain ${idx + 1} - ${item.location || 'No location'}</h4>
                                            <div class="item-grid">
                                                <div class="item-detail"><strong>Width:</strong><span>${item.width}mm</span></div>
                                                <div class="item-detail"><strong>Drop:</strong><span>${item.drop}mm</span></div>
                                                ${item.dropDeducted ? `<div class="item-detail"><strong>After Deductions:</strong><span>${item.dropDeducted}mm</span></div>` : ''}
                                                <div class="item-detail"><strong>Type:</strong><span>${item.curtainType}</span></div>
                                                <div class="item-detail"><strong>Hem:</strong><span>${item.hem}</span></div>
                                                <div class="item-detail"><strong>Fabric:</strong><span>${item.fabric}</span></div>
                                                <div class="item-detail"><strong>Colour:</strong><span>${item.colour}</span></div>
                                                ${item.lining ? `<div class="item-detail"><strong>Lining:</strong><span>${item.lining}</span></div>` : ''}
                                                ${item.installation ? `<div class="item-detail"><strong>Installation:</strong><span>${item.installation}</span></div>` : ''}
                                                ${item.trackType ? `<div class="item-detail"><strong>Track:</strong><span>${item.trackType}</span></div>` : ''}
                                                ${item.openingType ? `<div class="item-detail"><strong>Opening:</strong><span>${item.openingType}</span></div>` : ''}
                                                <div class="item-detail"><strong>Price:</strong><span>${item.price}</span></div>
                                            </div>
                                            ${item.itemNotes ? `<p style="margin-top: 10px;"><strong>Item Notes:</strong> ${item.itemNotes}</p>` : ''}
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="order-item">
                                            <h4>Blind ${idx + 1} - ${item.location || 'No location'}</h4>
                                            <div class="item-grid">
                                                <div class="item-detail"><strong>Width:</strong><span>${item.width}mm</span></div>
                                                <div class="item-detail"><strong>Drop:</strong><span>${item.drop}mm</span></div>
                                                <div class="item-detail"><strong>Group:</strong><span>Group ${item.group}</span></div>
                                                <div class="item-detail"><strong>Fixing:</strong><span>${item.fixing}</span></div>
                                                <div class="item-detail"><strong>Control:</strong><span>${item.control}</span></div>
                                                <div class="item-detail"><strong>Fabric:</strong><span>${item.fabric}</span></div>
                                                <div class="item-detail"><strong>Colour:</strong><span>${item.colour}</span></div>
                                                ${item.discount && item.discount !== '0' ? `<div class="item-detail"><strong>Discount:</strong><span>${item.discount}%</span></div>` : ''}
                                                <div class="item-detail"><strong>Price:</strong><span>${item.price}</span></div>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                            ${order.notes ? `<p style="margin-top: 15px;"><strong>Additional Notes:</strong> ${order.notes}</p>` : ''}
                            ${user ? `<p style="margin-top: 10px;"><strong>Address:</strong> ${user.address}</p>` : ''}
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-info" onclick="exportOrderToCSV(${order.id})">ðŸ“¥ Export to CSV</button>
                                ${order.status === 'pending' ? `<button class="btn btn-success" onclick="confirmOrder(${order.id})">âœ“ Confirm & Start Production</button>` : ''}
                                ${order.status === 'confirmed' ? `<button class="btn btn-primary" onclick="changeOrderStatus(${order.id}, 'production')">ðŸ­ Move to Production</button>` : ''}
                                ${order.status === 'production' ? `<button class="btn btn-success" onclick="changeOrderStatus(${order.id}, 'completed')">âœ“ Mark as Completed</button>` : ''}
                            </div>
                        </div>
                    </details>
                </div>
            `}).reverse().join('');
        }
        function exportOrderToCSV(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.id === order.userId) || {};

            let csv = '';
            
            if (order.productType === 'curtains') {
                // Curtain CSV format
                csv = 'SIGNATURE SHADES - CURTAIN ORDER FORM\n\n';
                csv += `Customer Name:,${order.customerName}\n`;
                csv += `Company Name:,${order.companyName}\n`;
                csv += `Address:,${user.address || ''}\n`;
                csv += `Phone:,${user.phone || ''}\n`;
                csv += `Email:,${user.email || ''}\n`;
                csv += `Order Date:,${order.orderDate}\n`;
                csv += `Date Required By:,${order.dateRequired || ''}\n`;
                csv += `Total Curtains:,${order.items.length}\n`;
                csv += `Order Status:,${order.status.toUpperCase()}\n\n`;

                // Curtain items header
                csv += 'No,Location,Width,Drop,After Deductions Drop,Curtain Type,Hem,Fabric,Colour,Lining,Installation,Bracket Type,Track Type,Track Colour,Opening Type,Wand Size,Notes,Price\n';

                // Curtain items data
                order.items.forEach((item, index) => {
                    csv += `${index + 1},`;
                    csv += `"${item.location || ''}",`;
                    csv += `${item.width},`;
                    csv += `${item.drop},`;
                    csv += `${item.dropDeducted || ''},`;
                    csv += `"${item.curtainType || ''}",`;
                    csv += `"${item.hem || ''}",`;
                    csv += `"${item.fabric || ''}",`;
                    csv += `"${item.colour || ''}",`;
                    csv += `"${item.lining || ''}",`;
                    csv += `"${item.installation || ''}",`;
                    csv += `"${item.bracketType || ''}",`;
                    csv += `"${item.trackType || ''}",`;
                    csv += `"${item.trackColour || ''}",`;
                    csv += `"${item.openingType || ''}",`;
                    csv += `${item.wandSize || ''},`;
                    csv += `"${item.itemNotes || ''}",`;
                    csv += `"${item.price || ''}"\n`;
                });
            } else {
                // Blind CSV format
                csv = 'SIGNATURE SHADES - BLINDS ORDER FORM\n\n';
                csv += `Customer Name:,${order.customerName}\n`;
                csv += `Company Name:,${order.companyName}\n`;
                csv += `Address:,${user.address || ''}\n`;
                csv += `Phone:,${user.phone || ''}\n`;
                csv += `Email:,${user.email || ''}\n`;
                csv += `Order Date:,${order.orderDate}\n`;
                csv += `Date Required By:,${order.dateRequired || ''}\n`;
                csv += `Total Blinds:,${order.items.length}\n`;
                csv += `Order Status:,${order.status.toUpperCase()}\n\n`;

                // Blind items header
                csv += 'Number,Location,Width,Drop,Fixing,Bracket Type,Bracket Colour,Control Side,Chain/Motor,Roll,Material,Fabric Type,Fabric Colour,Bottom Rail Type,Bottom Rail Colour,Group,Discount %,Price\n';

                // Blind items data
                order.items.forEach((item, index) => {
                    csv += `${index + 1},`;
                    csv += `"${item.location || ''}",`;
                    csv += `${item.width},`;
                    csv += `${item.drop},`;
                    csv += `"${item.fixing || ''}",`;
                    csv += `"${item.bracketType || ''}",`;
                    csv += `"${item.bracketColour || ''}",`;
                    csv += `"${item.controlSide || ''}",`;
                    csv += `"${item.chainMotor || ''}",`;
                    csv += `"${item.roll || ''}",`;
                    csv += `"${item.material || ''}",`;
                    csv += `"${item.fabricType || ''}",`;
                    csv += `"${item.fabricColour || ''}",`;
                    csv += `"${item.railType || ''}",`;
                    csv += `"${item.railColour || ''}",`;
                    csv += `${item.group || ''},`;
                    csv += `${item.discount || 0},`;
                    csv += `"${item.price || ''}"\n`;
                });
            }

            // Additional Notes
            if (order.notes) {
                csv += `\nAdditional Notes:\n"${order.notes}"\n`;
            }

            // Totals
            csv += `\nTotal:,${order.total}\n`;

            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const productLabel = order.productType === 'curtains' ? 'Curtains' : 'Blinds';
            link.setAttribute('href', url);
            link.setAttribute('download', `${productLabel}_Order_${orderId}_${order.customerName.replace(/\s/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadPricingTable() {
            const group = document.getElementById('priceGroupSelect').value;
            const table = document.getElementById('pricingTable');
            
            if (!pricingData[group]) {
                table.innerHTML = '<tr><td>No pricing data available</td></tr>';
                return;
            }

            // Get widths and drops
            const widths = Object.keys(pricingData[group]).map(Number).sort((a, b) => a - b);
            const firstWidth = widths[0];
            const drops = Object.keys(pricingData[group][firstWidth]).map(Number).sort((a, b) => a - b);

            // Build table header
            let html = '<thead><tr><th>Drop / Width</th>';
            widths.forEach(width => {
                html += `<th>${width}mm</th>`;
            });
            html += '</tr></thead><tbody>';

            // Build table rows
            drops.forEach(drop => {
                html += `<tr><td class="row-header">${drop}mm</td>`;
                widths.forEach(width => {
                    const price = pricingData[group][width][drop];
                    html += `<td><input type="number" step="0.01" value="${price.toFixed(2)}" 
                             data-group="${group}" data-width="${width}" data-drop="${drop}" 
                             onchange="markPriceChanged(this)"></td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        function markPriceChanged(input) {
            input.style.background = '#fff3cd';
            input.style.borderColor = '#ffc107';
        }

        function savePricing() {
            const inputs = document.querySelectorAll('#pricingTable input[type="number"]');
            let changeCount = 0;

            inputs.forEach(input => {
                const group = input.dataset.group;
                const width = input.dataset.width;
                const drop = input.dataset.drop;
                const newPrice = parseFloat(input.value);

                if (!isNaN(newPrice) && newPrice >= 0) {
                    pricingData[group][width][drop] = newPrice;
                    input.style.background = '';
                    input.style.borderColor = '';
                    changeCount++;
                }
            });

            // Save to localStorage
            localStorage.setItem('customPricing', JSON.stringify(pricingData));

            showAlert('pricingAlert', `Pricing updated successfully! ${changeCount} prices saved.`, 'success');
        }

        function resetPricing() {
            if (!confirm('Are you sure you want to reset all pricing to default values? This cannot be undone.')) {
                return;
            }

            // Remove custom pricing from storage
            localStorage.removeItem('customPricing');
            
            // Reload the page to reset pricing data
            location.reload();
        }

        function exportPricingToCSV() {
            const group = document.getElementById('priceGroupSelect').value;
            
            if (!pricingData[group]) {
                alert('No pricing data available');
                return;
            }

            const widths = Object.keys(pricingData[group]).map(Number).sort((a, b) => a - b);
            const firstWidth = widths[0];
            const drops = Object.keys(pricingData[group][firstWidth]).map(Number).sort((a, b) => a - b);

            // Build CSV
            let csv = `Signature Shades - Group ${group} Pricing\n\n`;
            csv += 'Drop/Width,';
            csv += widths.join(',') + '\n';

            drops.forEach(drop => {
                csv += `${drop},`;
                const prices = widths.map(width => pricingData[group][width][drop].toFixed(2));
                csv += prices.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `Pricing_Group_${group}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function changeOrderStatus(orderId, newStatus) {
            const statusNames = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'production': 'Production',
                'completed': 'Completed'
            };
            
            if (!confirm(`Change order status to "${statusNames[newStatus]}"?`)) {
                return;
            }

            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                saveToStorage();
                
                // Reload all views
                loadAllOrders();
                loadMyOrders();
                loadCustomerManagement();
                
                alert(`Order status changed to "${statusNames[newStatus]}"!`);
            }
        }

        function confirmOrder(orderId) {
            if (!confirm('Confirm this order and move to production?')) {
                return;
            }

            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'production';
                saveToStorage();
                
                // Export CSV automatically
                exportOrderToCSV(orderId);
                
                // Reload the orders view
                loadAllOrders();
                loadMyOrders();
                loadCustomerManagement();
                
                alert('Order confirmed and moved to production! CSV file has been downloaded.');
            }
        }
    </script>
</body>
</html>
